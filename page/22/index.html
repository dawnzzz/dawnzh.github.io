<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dawnzzz.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="个人博客站点">
<meta property="og:type" content="website">
<meta property="og:title" content="Dawn&#39;s Blogs">
<meta property="og:url" content="http://dawnzzz.github.io/page/22/index.html">
<meta property="og:site_name" content="Dawn&#39;s Blogs">
<meta property="og:description" content="个人博客站点">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="DawnZH">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://dawnzzz.github.io/page/22/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Dawn's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Dawn's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">分享技术 记录成长</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/27/Java%E5%9F%BA%E7%A1%80-8-%E6%8E%A5%E5%8F%A3%E5%92%8C%E5%86%85%E9%83%A8%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/27/Java%E5%9F%BA%E7%A1%80-8-%E6%8E%A5%E5%8F%A3%E5%92%8C%E5%86%85%E9%83%A8%E7%B1%BB/" class="post-title-link" itemprop="url">Java基础 (8) 接口和内部类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-27 16:06:41" itemprop="dateCreated datePublished" datetime="2023-01-27T16:06:41+08:00">2023-01-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">Java基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><h2 id="为什么需要接口"><a href="#为什么需要接口" class="headerlink" title="为什么需要接口"></a>为什么需要接口</h2><p>一方面，有时必须从几个类中派生出一个子类，继承它们所有的属性和方法。但是，Java 不支持多重继承。有了<strong>接口，就可以得到多重继承的效果</strong>。</p>
<p>另一方面，有时必须<strong>从几个类中抽取出一些共同的行为特征</strong>，而它们之间又没有 is-a 的关系，仅仅是<strong>具有相同的行为特征</strong>而已。如：鼠标、键盘、打印机等都支持 USB 连接。</p>
<p>接口就是规范，定义的是一组规则。继承实现的是<strong>是不是</strong>的逻辑，而接口定义的是<strong>能不能</strong>的逻辑。</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>接口是<strong>抽象方法</strong>和<strong>常量</strong>定义的集合：</p>
<ul>
<li>接口中所有的成员变量<strong>默认</strong>都是 public static final 修饰的。</li>
<li>接口中所有抽象方法默认<strong>都是</strong> public abstract 修饰的。</li>
<li>接口中<strong>没有构造器</strong>。</li>
<li>接口与接口之间可以多继承。</li>
<li>与继承关系类似，<strong>接口与实现类之间存在多态性</strong>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span> <span class="keyword">implements</span> <span class="title">InterfaceA</span>, <span class="title">InterfaceB</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/27/Java%E5%9F%BA%E7%A1%80-8-%E6%8E%A5%E5%8F%A3%E5%92%8C%E5%86%85%E9%83%A8%E7%B1%BB/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/27/Java%E5%9F%BA%E7%A1%80-7-%E4%BB%A3%E7%A0%81%E5%9D%97%E4%B8%8E%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/27/Java%E5%9F%BA%E7%A1%80-7-%E4%BB%A3%E7%A0%81%E5%9D%97%E4%B8%8E%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95/" class="post-title-link" itemprop="url">Java基础 (7) 代码块与抽象类抽象方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-27 14:55:12" itemprop="dateCreated datePublished" datetime="2023-01-27T14:55:12+08:00">2023-01-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">Java基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h1><p>代码块的作用是：<strong>对类或者对象进行初始化</strong>。</p>
<p>代码块只能被 static 修饰，所以分为：静态代码块和非静态代码块。</p>
<h2 id="静态代码块"><a href="#静态代码块" class="headerlink" title="静态代码块"></a>静态代码块</h2><ul>
<li><strong>静态代码块：</strong>用 static 修饰的代码块。<ul>
<li><strong>不可以对非静态的属性初始化</strong>。即不可以调用非静态的属性和方法。</li>
<li>若有多个静态的代码块，那么按照<strong>从上到下</strong>的顺序依次执行。</li>
<li>静态代码块的执行要<strong>先于</strong>非静态代码块。</li>
<li>静态代码块随着类的加载而加载，且<strong>只执行一次</strong>。</li>
</ul>
</li>
</ul>
<h2 id="非静态代码块"><a href="#非静态代码块" class="headerlink" title="非静态代码块"></a>非静态代码块</h2><ul>
<li><strong>非静态代码块：</strong>没有 static 修饰的代码块。<ul>
<li>除了<strong>调用非静态</strong>的结构外，还可以<strong>调用静态</strong>的变量或方法。</li>
<li>若有多个非静态的代码块，那么按照<strong>从上到下</strong>的顺序依次执行。</li>
<li>每次创建对象的时候，<strong>都会执行一次</strong>；且<strong>先于构造器执行</strong>。</li>
</ul>
</li>
</ul>
<h1 id="抽象类与抽象方法"><a href="#抽象类与抽象方法" class="headerlink" title="抽象类与抽象方法"></a>抽象类与抽象方法</h1><p>随着继承层次中一个个新子类的定义，类变得越来越具体，而父类则更一般，更通用。类的设计应该保证父类和子类能够共享特征。<strong>有时将一个父类设计得非常抽象，以至于它没有具体的实例</strong>，这样的类叫做<strong>抽象类</strong>。</p>
<p>用 <strong>abstract</strong> 关键字修饰的类或者方法叫做抽象类或者抽象方法。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/27/Java%E5%9F%BA%E7%A1%80-7-%E4%BB%A3%E7%A0%81%E5%9D%97%E4%B8%8E%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%8A%BD%E8%B1%A1%E6%96%B9%E6%B3%95/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/27/Java%E5%9F%BA%E7%A1%80-6-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E5%92%8C%E5%8C%85%E8%A3%85%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/27/Java%E5%9F%BA%E7%A1%80-6-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E5%92%8C%E5%8C%85%E8%A3%85%E7%B1%BB/" class="post-title-link" itemprop="url">Java基础 (6) 单元测试方法和包装类</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-27 10:54:53" itemprop="dateCreated datePublished" datetime="2023-01-27T10:54:53+08:00">2023-01-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">Java基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="单元测试方法"><a href="#单元测试方法" class="headerlink" title="单元测试方法"></a>单元测试方法</h1><p>Java 中的 JUnit 单元测试，步骤：</p>
<ul>
<li>创建 Java 类，进行单元测试。这个类要求：<ul>
<li>此类是 public 的。</li>
<li>此类提供公共的无参数构造器。</li>
</ul>
</li>
<li>此类中声明单元测试方法。单元测试方法要求：<ul>
<li>方法的权限是 public。</li>
<li>没有返回值、没有形参。</li>
</ul>
</li>
<li>单元测试方法上需要<strong>声明注解 @Test</strong>，并 <code>import org.junit.Test;</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JUnitTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testXXX</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 单元测试流程</span></span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="包装类"><a href="#包装类" class="headerlink" title="包装类"></a>包装类</h1><p>针对<strong>八种基本数据类型定义相应的引用类型</strong>，即<strong>包装类</strong>（封装类）。有了类的特点，就可以调用类中的方法，Java 才是真正的面向对象。</p>
<p><img src="/../images/Java%E5%9F%BA%E7%A1%80-6-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E5%92%8C%E5%8C%85%E8%A3%85%E7%B1%BB/image-20230127105607994.png" alt="image-20230127105607994"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/27/Java%E5%9F%BA%E7%A1%80-6-%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E5%92%8C%E5%8C%85%E8%A3%85%E7%B1%BB/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/25/Java%E5%9F%BA%E7%A1%80-5-%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E6%80%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/25/Java%E5%9F%BA%E7%A1%80-5-%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E6%80%81/" class="post-title-link" itemprop="url">Java基础 (5) 继承和多态</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-25 12:34:35" itemprop="dateCreated datePublished" datetime="2023-01-25T12:34:35+08:00">2023-01-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E5%9F%BA%E7%A1%80/" itemprop="url" rel="index"><span itemprop="name">Java基础</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h1><p>多个类中存在相同属性和行为时，将这些内容抽取到单独一个类中，只要<strong>继承</strong>那个类即可。继承的类称为<strong>子类（派生类）</strong>，被继承的类被称为<strong>父类（超类）</strong>。</p>
<blockquote>
<p>可以理解为：<strong>子类 is a 父类</strong>。</p>
</blockquote>
<p>一旦子类继承父类之后，子类就获取到了父类中声明的<strong>所有</strong>属性和方法。</p>
<p>继承语法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">SuperClass</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Java 中，一个子类只能由一个父类，一个父类可以派生出多个子类。继承的<strong>作用</strong>：</p>
<ul>
<li>继承的出现<strong>减少了代码冗余</strong>，提高了代码的<strong>复用性</strong>。</li>
<li>继承的出现，更有利于<strong>功能的扩展</strong>。</li>
<li> 继承的出现让<strong>类与类之间产生了关系</strong>。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/25/Java%E5%9F%BA%E7%A1%80-5-%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E6%80%81/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/16/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%92%8CAOF%E9%87%8D%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/16/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%92%8CAOF%E9%87%8D%E5%86%99/" class="post-title-link" itemprop="url">godis源码阅读 (6) AOF持久化和AOF重写</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-16 20:48:16" itemprop="dateCreated datePublished" datetime="2023-01-16T20:48:16+08:00">2023-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">godis源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AOF-持久化"><a href="#AOF-持久化" class="headerlink" title="AOF 持久化"></a>AOF 持久化</h1><h2 id="数据结构定义"><a href="#数据结构定义" class="headerlink" title="数据结构定义"></a>数据结构定义</h2><h3 id="Persister"><a href="#Persister" class="headerlink" title="Persister"></a>Persister</h3><p>Persister 是 AOF 持久化中的核心数据结构，它从 channel 中接收消息并且将消息写入到 AOF 文件中。部分字段如下：</p>
<ul>
<li>db：这个 AOF 持久化协程所指向的<strong>数据库</strong>。</li>
<li>tmpDBMaker：新建一个<strong>临时</strong>的数据库，用于 AOF 重新操作。</li>
<li>aofChan：Persister 就是从这个<strong>通道</strong>中监听消息，并且将消息<strong>写入到 AOF 文件</strong>中的。</li>
<li>aofFsync：AOF 文件<strong>刷入到磁盘的策略</strong>，有三种选项可以选择：<strong>FsyncAlways</strong>（每一个命令都会进行刷盘操作），<strong>FsyncEverySec</strong>（每秒钟进行一次刷盘操作），<strong>FsyncNo</strong>（不主动进行刷盘操作，交给操作系统去决定）。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Listener will be called-back after receiving a aof payload</span></span><br><span class="line"><span class="comment">// with a listener we can forward the updates to slave nodes etc.</span></span><br><span class="line"><span class="keyword">type</span> Listener <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Callback will be called-back after receiving a aof payload</span></span><br><span class="line">	Callback([]CmdLine)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Persister receive msgs from channel and write to AOF file</span></span><br><span class="line"><span class="keyword">type</span> Persister <span class="keyword">struct</span> &#123;</span><br><span class="line">   ctx         context.Context</span><br><span class="line">   cancel      context.CancelFunc</span><br><span class="line">   db          database.DBEngine</span><br><span class="line">   tmpDBMaker  <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">database</span>.<span class="title">DBEngine</span></span></span><br><span class="line">   aofChan     <span class="keyword">chan</span> *payload</span><br><span class="line">   aofFile     *os.File</span><br><span class="line">   aofFilename <span class="keyword">string</span></span><br><span class="line">   aofFsync    <span class="keyword">string</span></span><br><span class="line">   <span class="comment">// aof goroutine will send msg to main goroutine through this channel when aof tasks finished and ready to shut down</span></span><br><span class="line">   aofFinished <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">   <span class="comment">// pause aof for start/finish aof rewrite progress</span></span><br><span class="line">   pausingAof sync.Mutex</span><br><span class="line">   currentDB  <span class="keyword">int</span></span><br><span class="line">   listeners  <span class="keyword">map</span>[Listener]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">   <span class="comment">// reuse cmdLine buffer</span></span><br><span class="line">   buffer []CmdLine</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p><strong>payload 为 aofChan 通道内的消息</strong>，包括：命令行参数（cmdLine）、数据库（dbIndex）、用于同步的信号量（wg）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CmdLine is alias for [][]byte, represents a command line</span></span><br><span class="line"><span class="keyword">type</span> CmdLine = [][]<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> payload <span class="keyword">struct</span> &#123;</span><br><span class="line">   cmdLine CmdLine</span><br><span class="line">   dbIndex <span class="keyword">int</span></span><br><span class="line">   wg      *sync.WaitGroup</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="NewPersister-新建一个-AOF-持久化工作协程"><a href="#NewPersister-新建一个-AOF-持久化工作协程" class="headerlink" title="NewPersister 新建一个 AOF 持久化工作协程"></a>NewPersister 新建一个 AOF 持久化工作协程</h2><p>数据库可以利用 NewPersister 方法新建一个 AOF 持久化进程进行 AOF 持久化。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewPersister creates a new aof.Persister</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewPersister</span><span class="params">(db database.DBEngine, filename <span class="keyword">string</span>, load <span class="keyword">bool</span>, fsync <span class="keyword">string</span>, tmpDBMaker <span class="keyword">func</span>()</span> <span class="title">database</span>.<span class="title">DBEngine</span>) <span class="params">(*Persister, error)</span></span></span><br></pre></td></tr></table></figure>

<p>其流程如下：</p>
<ul>
<li><strong>新建一个 Persister</strong>，填写 AOF 文件名、刷盘策略、数据库等信息。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">persister := &amp;Persister&#123;&#125;</span><br><span class="line">persister.aofFilename = filename</span><br><span class="line">persister.aofFsync = strings.ToLower(fsync)</span><br><span class="line">persister.db = db</span><br><span class="line">persister.tmpDBMaker = tmpDBMaker</span><br><span class="line">persister.currentDB = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果需要<strong>加载 AOF 文件</strong>中已有的数据，则执行 persister.LoadAof 方法加载命令。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> load &#123;</span><br><span class="line">   persister.LoadAof(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>打开 AOF 持久化文件</strong>，初始化监听命令的通道等。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aofFile, err := os.OpenFile(persister.aofFilename, os.O_APPEND|os.O_CREATE|os.O_RDWR, <span class="number">0600</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">persister.aofFile = aofFile</span><br><span class="line">persister.aofChan = <span class="built_in">make</span>(<span class="keyword">chan</span> *payload, aofQueueSize)</span><br><span class="line">persister.aofFinished = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">persister.listeners = <span class="built_in">make</span>(<span class="keyword">map</span>[Listener]<span class="keyword">struct</span>&#123;&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>开启一个<strong>协程</strong>，用于<strong>监听 aofChan，将命令写入到 AOF 文件中</strong>。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   persister.listenCmd()</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<ul>
<li>如果<strong>刷盘策略为 FsyncEverySec</strong>，则开启一个协程用于<strong>每秒钟刷盘操作</strong>。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">persister.ctx = ctx</span><br><span class="line">persister.cancel = cancel</span><br><span class="line"><span class="keyword">if</span> persister.aofFsync == FsyncEverySec &#123;</span><br><span class="line">   persister.fsyncEverySecond()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> persister, <span class="literal">nil</span></span><br></pre></td></tr></table></figure>

<h3 id="fsyncEverySecond-每秒钟的刷盘操作"><a href="#fsyncEverySecond-每秒钟的刷盘操作" class="headerlink" title="fsyncEverySecond 每秒钟的刷盘操作"></a>fsyncEverySecond 每秒钟的刷盘操作</h3><p>persister.fsyncEverySecond 方法用于每秒钟的刷盘操作，它每过一秒钟执行一次 persister.aofFile.Sync，将内存中的数据刷入到磁盘中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(persister *Persister)</span> <span class="title">fsyncEverySecond</span><span class="params">()</span></span> &#123;</span><br><span class="line">   ticker := time.NewTicker(time.Second)</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">         <span class="keyword">select</span> &#123;</span><br><span class="line">         <span class="keyword">case</span> &lt;-ticker.C:</span><br><span class="line">            persister.pausingAof.Lock()</span><br><span class="line">            <span class="keyword">if</span> err := persister.aofFile.Sync(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">               logger.Errorf(<span class="string">&quot;fsync failed: %v&quot;</span>, err)</span><br><span class="line">            &#125;</span><br><span class="line">            persister.pausingAof.Unlock()</span><br><span class="line">         <span class="keyword">case</span> &lt;-persister.ctx.Done():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/16/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-6-AOF%E6%8C%81%E4%B9%85%E5%8C%96%E5%92%8CAOF%E9%87%8D%E5%86%99/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/09/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-pipeline%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/09/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-pipeline%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF/" class="post-title-link" itemprop="url">godis源码阅读 (5) pipeline模式的客户端</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-09 10:06:08" itemprop="dateCreated datePublished" datetime="2023-01-09T10:06:08+08:00">2023-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">godis源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Pipeline-模式"><a href="#Pipeline-模式" class="headerlink" title="Pipeline 模式"></a>Pipeline 模式</h1><p><strong>通常 TCP 客户端</strong>的通信模式都是<strong>阻塞式</strong>的：客户端发送请求 -&gt; 等待服务端响应 -&gt; 发送下一个请求。因为需要等待网络传输数据，完成一次请求循环需要等待较多时间。</p>
<p>针对这种效率低的情景，可以<strong>不等待服务端响应直接发送下一条请求</strong>。</p>
<blockquote>
<p>TCP 协议会<strong>保证数据流的有序性</strong>，同一个 TCP 连接上先发送的请求服务端先接收，先回复的响应客户端先收到。因此不必担心混淆响应所对应的请求。</p>
</blockquote>
<p>这种在<strong>服务端未响应时客户端继续向服务端发送请求</strong>的模式称为 Pipeline 模式。因为减少等待网络传输的时间，Pipeline 模式可以极大的提高吞吐量。</p>
<h1 id="Godis-客户端"><a href="#Godis-客户端" class="headerlink" title="Godis 客户端"></a>Godis 客户端</h1><p>Pipeline 模式的 Godis 客户端需要至少有两个后台协程，分别是<strong>发送请求协程（写协程）</strong>和<strong>读取响应协程（读协程）</strong>。调用方<strong>通过 channel 向后台协程发送发送指令</strong>，并<strong>阻塞等待</strong>直到收到响应（或者超时）。</p>
<h2 id="Client-结构"><a href="#Client-结构" class="headerlink" title="Client 结构"></a>Client 结构</h2><p>首先定义 Client 客户端，Client 客户端实现 pipeline 的核心在于两个<strong>通道</strong>：</p>
<ul>
<li><strong>pendingReqs：</strong>记录<strong>等待发送</strong>的请求，客户端调用 Send 命令向客户端发送请求时，请求在这个通道内<strong>排队等待写协程发送请求</strong>。</li>
<li><strong>waitingReqs：</strong>记录<strong>等待服务器响应</strong>的请求，向服务器发送请求成功后将这个请求<strong>加入到这个通道中等待响应</strong>。当读协程<strong>收到一个服务器响应</strong>时就从通道中<strong>取出一个请求</strong>，此时一个完整的请求+响应完成。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">    conn        net.Conn <span class="comment">// 与服务端的 tcp 连接</span></span><br><span class="line">    pendingReqs <span class="keyword">chan</span> *Request <span class="comment">// 等待发送的请求</span></span><br><span class="line">    waitingReqs <span class="keyword">chan</span> *Request <span class="comment">// 等待服务器响应的请求</span></span><br><span class="line">    ticker      *time.Ticker <span class="comment">// 用于触发心跳包的计时器</span></span><br><span class="line">    addr        <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    status  	<span class="keyword">int32</span>	<span class="comment">// 服务器状态（创建/运行/关闭）</span></span><br><span class="line">    working    *sync.WaitGroup <span class="comment">// 有请求正在处理不能立即停止，用于实现 graceful shutdown</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着定义客户端的请求 Request：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</span><br><span class="line">    id        <span class="keyword">uint64</span> <span class="comment">// 请求id</span></span><br><span class="line">    args      [][]<span class="keyword">byte</span> <span class="comment">// 上行参数</span></span><br><span class="line">    reply     redis.Reply <span class="comment">// 收到的返回值</span></span><br><span class="line">    heartbeat <span class="keyword">bool</span> <span class="comment">// 标记是否是心跳请求</span></span><br><span class="line">    waiting   *wait.Wait <span class="comment">// 调用协程发送请求后通过 waitgroup 等待请求异步处理完成</span></span><br><span class="line">    err       error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="wait-Wait"><a href="#wait-Wait" class="headerlink" title="wait.Wait"></a>wait.Wait</h3><p>客户端请求中 waiting 属性的类型为 wait.Wait，实际上就是 sync.WaitGroup 加上了<strong>超时</strong>功能。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wait is similar with sync.WaitGroup which can wait with timeout</span></span><br><span class="line"><span class="keyword">type</span> Wait <span class="keyword">struct</span> &#123;</span><br><span class="line">	wg sync.WaitGroup</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wait.Wait 和 sync.WaitGroup 一样也有 Add、Done、Wait 方法。不同的是，它额外有一个 WaitWithTimeout 方法，这个方法<strong>阻塞 WaitGroup 直到计数器为零或者超时</strong>。其实现的方法是：</p>
<ul>
<li>定义一个<strong>管道</strong>，用于<strong>接收完成信号</strong>。</li>
<li>开启一个<strong>协程</strong>，调用 Wait 阻塞协程， WaitGroup 计数器为零。当<strong>计数器为零时向管道中发送信号</strong>，表明完成任务。</li>
<li>使用 Select 阻塞，当<strong>超时</strong>或者<strong>完成任务（在管道中检测到信号）</strong>时，方法<strong>结束阻塞返回</strong>。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/09/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-5-pipeline%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/08/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87-A-Simple-yet-Effective-Relation-Information-Guided-Approach-for-Few-Shot-Relation-Extraction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/08/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87-A-Simple-yet-Effective-Relation-Information-Guided-Approach-for-Few-Shot-Relation-Extraction/" class="post-title-link" itemprop="url">关系抽取论文 A Simple yet Effective Relation Information Guided Approach for Few-Shot Relation Extraction</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-08 10:35:14" itemprop="dateCreated datePublished" datetime="2023-01-08T10:35:14+08:00">2023-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87/" itemprop="url" rel="index"><span itemprop="name">关系抽取论文</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p><strong>A Simple yet Effective Relation Information Guided Approach for Few-Shot Relation Extraction</strong></p>
<p>年份：2022</p>
<p>会议：ACL</p>
<p>作者：Yang Liu, Jinpeng Hu, Xiang wan, Tsung-Hui Chang</p>
<p>机构：The Chinese University of Hong Kong</p>
<p>数据集：FewRel 1.0</p>
<p>motivation：在 few-shot 关系抽取任务上应用原型网络有两个限制，因此论文提出了一种直接而有效的方法将关系信息融合进网络之中。</p>
<ul>
<li>局限一：现有模型中的大多数都采用了隐式约束，如对比学习或者关系图，而不是直接融合关系信息到网络中。这会导致在面对 remote samples 时，表现较弱。</li>
<li>局限二：它们通常采用复杂的设计或网络，如混合特征或精心设计的注意力网络，这可能会带来太多甚至是有害的参数。</li>
<li>论文中的具体做法是：<ul>
<li>使用相同的编码器来编码关系信息和句子，并将它们映射到相同的语义空间中。</li>
<li>通过连接两个关系视图（比如 CLS token embedding 和所有 tokens 的平均）来为每个关系类生成关系表示 relation representation，这使得关系表示和原型有相同的维度。然后，将生成的关系表示直接与原型<strong>相加</strong>。</li>
</ul>
</li>
</ul>
<p><img src="/../images/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87-A-Simple-yet-Effective-Relation-Information-Guided-Approach-for-Few-Shot-Relation-Extraction/image-20230108113527122.png" alt="image-20230108113527122"></p>
<p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/lylylylylyly/SimpleFSRE">https://github.com/lylylylylyly/SimpleFSRE</a></p>
</blockquote>
<p>因为关系抽取数据集人工标注困难，所以开始研究 Few-Shot Relation Extraction（FSRE）。这个任务在现有关系的大规模数据集上进行训练，然后快速迁移到新关系类型的少量数据上。</p>
<p><strong>原型网络（Prototypical Networks）</strong>是 Few-Shot 的方法，就是先把样本投影到一个空间，<strong>计算每个样本类别的中心</strong>，在分类的时候，通过对比<strong>目标到每个中心的距离</strong>，从而分析出目标的类别。</p>
<p><img src="/../images/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87-A-Simple-yet-Effective-Relation-Information-Guided-Approach-for-Few-Shot-Relation-Extraction/image-20230108111547412.png" alt="image-20230108111547412"></p>
<blockquote>
<p><strong>原型网络</strong>具体实现就是：</p>
<ul>
<li>首先是把输入投影到新的特征空间，通过神经网络，把输入转化为一个新的特征向量，使得同一类的向量之间的距离比较接近，不同类的向量距离比较远。</li>
<li>计算每个类别的均值表示该类的原型。</li>
</ul>
</blockquote>
<p>针对现有方法在 RE 上应用原型网络的两个缺陷，论文提出通过<strong>连接两个关系视图</strong>（比如 CLS token embedding 和所有 tokens 的平均）来为每个关系类生成关系表示，这<strong>使得关系表示和原型有相同的维度</strong>。然后，在训练和预测时将生成的关系表示直接与原型<strong>相加</strong>。至于为什么直接相加的方法适用于 few-shot RE，作者是这样解释的：</p>
<ul>
<li>直接相加更具有<strong>鲁棒性</strong>，在面对 remote samples 时。</li>
<li>直接相加<strong>不会带来额外的参数，简化了模型</strong>。由于过拟合的问题，<strong>较少的参数总是比较多的参数更好</strong>，特别是对于较少数据量的任务。</li>
</ul>
<h1 id="模型结构"><a href="#模型结构" class="headerlink" title="模型结构"></a>模型结构</h1><p>最重要的是以下两个部分：</p>
<ul>
<li><p>为了将句子和关系信息的表示映射到同一语义空间中，使用了<strong>共享句子编码器</strong>。</p>
</li>
<li><p>接着<strong>连接两个关系表示的两个视图</strong>，用于得到与原型相同的维度。通过直接<strong>加法</strong>，将关系表示集成到原始原型中</p>
</li>
</ul>
<p><img src="/../images/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87-A-Simple-yet-Effective-Relation-Information-Guided-Approach-for-Few-Shot-Relation-Extraction/image-20230108114447540.png" alt="image-20230108114447540"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/08/%E5%85%B3%E7%B3%BB%E6%8A%BD%E5%8F%96%E8%AE%BA%E6%96%87-A-Simple-yet-Effective-Relation-Information-Guided-Approach-for-Few-Shot-Relation-Extraction/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BList%E5%92%8CSortedSet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BList%E5%92%8CSortedSet/" class="post-title-link" itemprop="url">godis源码阅读 (4) 存储数据结构之List和SortedSet</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-06 21:30:37" itemprop="dateCreated datePublished" datetime="2023-01-06T21:30:37+08:00">2023-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">godis源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="List"><a href="#List" class="headerlink" title="List"></a>List</h1><p>simple-redis 中定义了 List 接口，以定义 List 的各种操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expected check whether given item is equals to expected value</span></span><br><span class="line"><span class="keyword">type</span> Expected <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer traverses list.</span></span><br><span class="line"><span class="comment">// It receives index and value as params, returns true to continue traversal, while returns false to break</span></span><br><span class="line"><span class="keyword">type</span> Consumer <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>, v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> List <span class="keyword">interface</span> &#123;</span><br><span class="line">   Add(val <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">   Get(index <span class="keyword">int</span>) (val <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">   Set(index <span class="keyword">int</span>, val <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">   Insert(index <span class="keyword">int</span>, val <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">   Remove(index <span class="keyword">int</span>) (val <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">   RemoveLast() (val <span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">   RemoveAllByVal(expected Expected) <span class="keyword">int</span></span><br><span class="line">   RemoveByVal(expected Expected, count <span class="keyword">int</span>) <span class="keyword">int</span></span><br><span class="line">   ReverseRemoveByVal(expected Expected, count <span class="keyword">int</span>) <span class="keyword">int</span></span><br><span class="line">   Len() <span class="keyword">int</span></span><br><span class="line">   ForEach(consumer Consumer)</span><br><span class="line">   Contains(expected Expected) <span class="keyword">bool</span></span><br><span class="line">   Range(start <span class="keyword">int</span>, stop <span class="keyword">int</span>) []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="快速链表"><a href="#快速链表" class="headerlink" title="快速链表"></a>快速链表</h3><p>在 simple-redis 中，采用<strong>快速链表</strong>作为 List 的数据结构。</p>
<p>快速链表实际上就是一个<strong>双向链表</strong>，但是双向链表中的每一个节点不是存储一个数据，而是<strong>将数据连续存放形成一段连续的存储空间</strong>作为链表的节点。</p>
<p>这一段连续的存储空间在 godis 中被称为 page（每一个 page 的大小为 1024），page 的类型为<strong>空接口切片</strong>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	pageSize = <span class="number">1024</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// QuickList 快速链表，用于实现list</span></span><br><span class="line"><span class="keyword">type</span> QuickList <span class="keyword">struct</span> &#123;</span><br><span class="line">	data *list.List</span><br><span class="line">	size <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>又定义了 iterator 为快速链表的迭代器，在 <code>[-1, QuickList.Len()]</code> 范围内移动。</p>
<ul>
<li>node 表示元素所在的 page。</li>
<li>offset 表示这个元素在 page 中的下标。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iterator of QuickList, move between [-1, ql.Len()]</span></span><br><span class="line"><span class="keyword">type</span> iterator <span class="keyword">struct</span> &#123;</span><br><span class="line">   node   *list.Element</span><br><span class="line">   offset <span class="keyword">int</span></span><br><span class="line">   ql     *QuickList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-4-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BList%E5%92%8CSortedSet/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BHash%E8%A1%A8%E5%92%8CLockMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BHash%E8%A1%A8%E5%92%8CLockMap/" class="post-title-link" itemprop="url">godis源码阅读 (3) 存储数据结构之Hash表和LockMap</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-06 19:58:52" itemprop="dateCreated datePublished" datetime="2023-01-06T19:58:52+08:00">2023-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">godis源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Hash-表"><a href="#Hash-表" class="headerlink" title="Hash 表"></a>Hash 表</h1><p>KV 内存数据库的核心是并发安全的哈希表，godis 采用<strong>分段锁</strong>策略。<strong>将 key 分散到固定数量的 shard 中，在一个 shard 内的读写操作不会阻塞其他 shard 内的操作</strong>。</p>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>定义 Dict 接口，该接口表示一个哈希表的操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Consumer is used to traversal dict, if it returns false the traversal will be break</span></span><br><span class="line"><span class="keyword">type</span> Consumer <span class="function"><span class="keyword">func</span><span class="params">(key <span class="keyword">string</span>, val <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Dict is interface of a key-value data structure</span></span><br><span class="line"><span class="keyword">type</span> Dict <span class="keyword">interface</span> &#123;</span><br><span class="line">   Get(key <span class="keyword">string</span>) (val <span class="keyword">interface</span>&#123;&#125;, exists <span class="keyword">bool</span>)</span><br><span class="line">   Len() <span class="keyword">int</span></span><br><span class="line">   Put(key <span class="keyword">string</span>, val <span class="keyword">interface</span>&#123;&#125;) (result <span class="keyword">int</span>)</span><br><span class="line">   PutIfAbsent(key <span class="keyword">string</span>, val <span class="keyword">interface</span>&#123;&#125;) (result <span class="keyword">int</span>)</span><br><span class="line">   PutIfExists(key <span class="keyword">string</span>, val <span class="keyword">interface</span>&#123;&#125;) (result <span class="keyword">int</span>)</span><br><span class="line">   Remove(key <span class="keyword">string</span>) (result <span class="keyword">int</span>)</span><br><span class="line">   ForEach(consumer Consumer)</span><br><span class="line">   Keys() []<span class="keyword">string</span></span><br><span class="line">   RandomKeys(limit <span class="keyword">int</span>) []<span class="keyword">string</span></span><br><span class="line">   RandomDistinctKeys(limit <span class="keyword">int</span>) []<span class="keyword">string</span></span><br><span class="line">   Clear()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义 ConcurrentDict 实现了 Dict 接口，ConcurrentDict 为并发安全的哈希表。<strong>将 key 映射到不同的 shard 中，不同 shard 上的操作是不会相互影响的</strong>，提高了<strong>并发性</strong>。</p>
<blockquote>
<p>注意，这里 shard 的数量恒为 2 的整数幂。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcurrentDict is thread safe map using sharding lock</span></span><br><span class="line"><span class="keyword">type</span> ConcurrentDict <span class="keyword">struct</span> &#123;</span><br><span class="line">   table      []*shard</span><br><span class="line">   count      <span class="keyword">int32</span></span><br><span class="line">   shardCount <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> shard <span class="keyword">struct</span> &#123;</span><br><span class="line">   m     <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">   mutex sync.RWMutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-3-%E5%AD%98%E5%82%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B9%8BHash%E8%A1%A8%E5%92%8CLockMap/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2-Redis%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2-Redis%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%E5%99%A8/" class="post-title-link" itemprop="url">godis源码阅读 (2) Redis协议解析器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-06 10:12:36" itemprop="dateCreated datePublished" datetime="2023-01-06T10:12:36+08:00">2023-01-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">godis源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Redis-通信协议"><a href="#Redis-通信协议" class="headerlink" title="Redis 通信协议"></a>Redis 通信协议</h1><p><strong>Redis 自 2.0 版本起使用了统一的协议 RESP（REdis Serialization Protocol，Redis 序列化协议）</strong>，该协议易于实现，计算机可以高效的进行解析且易于被人类读懂。</p>
<p>RESP 是一个<strong>二进制安全</strong>的文本协议，工作于 TCP 协议上。RESP 以<strong>行</strong>作为单位，客户端和服务器发送的命令或数据一律以 \r\n （CRLF）作为换行符。</p>
<h2 id="RESP-的五种格式"><a href="#RESP-的五种格式" class="headerlink" title="RESP 的五种格式"></a>RESP 的五种格式</h2><p>RESP 定义了 5 种格式：</p>
<ul>
<li><strong>简单字符串（Simple String）：</strong>服务器用来返回简单的结果，比如 OK。非二进制安全，不允许换行。</li>
<li><strong>错误信息（Error）：</strong>服务器用来返回简单的错误信息，比如 ERR Invalid Synatx。非二进制安全，且不允许换行。</li>
<li><strong>整数（Integer）：</strong>llen、scard 等命令的返回值，64位有符号整数。</li>
<li><strong>字符串（Bulk String）：</strong>二进制安全字符串。</li>
<li><strong>数组（Array，又称 Multi Bulk Strings）：</strong>Bulk String 数组，客户端发送指令以及 lrange 等命令响应的格式。</li>
</ul>
<p>RESP 通过第一个字符表示格式：</p>
<ul>
<li><strong>简单字符串：以 + 开始</strong>，如 +OK\r\n。</li>
<li><strong>错误：以 - 开始</strong>，如 -ERR Invalid Syntax\r\n。</li>
<li><strong>整数：以 : 开始</strong>，如 :1\r\n。</li>
<li><strong>字符串：以 $ 开始</strong>。Bulk String 有两行，第一行为 $+正文长度，第二行为实际内容。$-1 表示 nil，当使用 get 查询一个不存在的 key 时，响应为 nil。</li>
<li><strong>数组：以 * 开始</strong>。第一行为 *+数组长度，其后是相应数量的 Bulk String。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/01/06/godis%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-2-Redis%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%E5%99%A8/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/21/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><span class="page-number current">22</span><a class="page-number" href="/page/23/">23</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><a class="extend next" rel="next" href="/page/23/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DawnZH</p>
  <div class="site-description" itemprop="description">个人博客站点</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">415</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DawnZH</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
