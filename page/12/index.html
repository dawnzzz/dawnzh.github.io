<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dawnzzz.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="个人博客站点">
<meta property="og:type" content="website">
<meta property="og:title" content="Dawn&#39;s Blogs">
<meta property="og:url" content="http://dawnzzz.github.io/page/12/index.html">
<meta property="og:site_name" content="Dawn&#39;s Blogs">
<meta property="og:description" content="个人博客站点">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="DawnZH">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://dawnzzz.github.io/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Dawn's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Dawn's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">分享技术 记录成长</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/10/03/Kubernetes%E5%AD%A6%E4%B9%A0-9-%E4%BA%86%E8%A7%A3Kubernetes%E6%9C%BA%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/03/Kubernetes%E5%AD%A6%E4%B9%A0-9-%E4%BA%86%E8%A7%A3Kubernetes%E6%9C%BA%E7%90%86/" class="post-title-link" itemprop="url">Kubernetes学习 (9) 了解Kubernetes机理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-03 12:15:16" itemprop="dateCreated datePublished" datetime="2023-10-03T12:15:16+08:00">2023-10-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">Kubernetes学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="/../images/Kubernetes%E5%AD%A6%E4%B9%A0-9-%E4%BA%86%E8%A7%A3Kubernetes%E6%9C%BA%E7%90%86/components-of-kubernetes.svg" alt="Components of Kubernetes"></p>
<ul>
<li><p><strong>控制平面（Control Plane）组件：</strong>控制平面组件会为集群做出全局决策，比如资源的调度、 以及检测和响应集群事件。</p>
<ul>
<li><p><strong>kube-apiserver：</strong>API 服务器，相当于控制平面的前端负责接受请求，可以水平扩容。</p>
</li>
<li><p><strong>etcd：</strong>所有集群数据的后台数据库。</p>
</li>
<li><p><strong>kube-scheduler：</strong>负责 Pod 的调度决策工作。</p>
</li>
<li><p><strong>kube-controller-manager：</strong>负责运行控制器进程（控制器通过 API 服务器监控集群的公共状态，并致力于将当前的状态转换为期望的状态）。从逻辑上讲， 每个控制器都是一个单独的进程， 但是为了降低复杂性，它们都被编译到同一个可执行文件，并在同一个进程中运行。控制器包括但不限于：</p>
<ul>
<li>节点控制器：负责在节点出现故障时进行通知和响应。</li>
<li>任务控制器：监测代表一次性任务的 Job 对象，然后创建 Pods 来运行这些任务直至完成。</li>
<li>端点分片控制器：填充端点分片（EndpointSlice）对象（以提供 Service 和 Pod 之间的链接）。</li>
<li>服务账号控制器：为新的命名空间创建默认的服务账号（ServiceAccount）。</li>
</ul>
</li>
<li><p><strong>cloud-controller-manager：</strong>仅运行特定于云平台的控制器。</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>Node 组件：</strong>节点组件会在每个节点上运行，负责维护运行的 Pod 并提供 Kubernetes 运行环境。</p>
<ul>
<li><p><strong>kubelet：</strong>在每一个节点上运行，用于管理运行在这个节点上的 Pod。</p>
</li>
<li><p><strong>kube-proxy：</strong>是每一个节点上的网络代理，维护节点上的一些网络规则， 这些网络规则会允许从集群内部或外部的网络会话与 Pod 进行网络通信。</p>
</li>
<li><p><strong>容器运行时（Container Runtime）：</strong>负责运行容器的软件。</p>
</li>
</ul>
</li>
</ul>
<h2 id="组件间的分布式特性"><a href="#组件间的分布式特性" class="headerlink" title="组件间的分布式特性"></a>组件间的分布式特性</h2><p><strong>组件之间的通信：</strong>在 Kubernetes 组件之间，只能<strong>通过 API 服务器进行通信</strong>，组件之间<strong>不会</strong>直接通信。</p>
<p><strong>多实例保证可用性：</strong>为了保证高可用性，控制平面上的组件都是可以<strong>多实例运行</strong>的。其中，etcd 和 API 服务器都是可以<strong>多实例并行工作</strong>的。但是，同类型的调度器和控制器管理器<strong>只有一个实例起作用</strong>，其他实例均在待命。</p>
<p><strong>组件运行方式：</strong>控制平面组件和 kube-proxy 都是直接在系统上运行或者<strong>作为 Pod 运行</strong>。kubelet 直接在系统上运行，把其他组件作为 Pod 运行。为了使得控制平面组件作为 Pod 运行，kubelet 也被部署在 master 上。</p>
<blockquote>
<p>控制平面上的所有组件作为 Pod，在 master 节点上运行（master 节点上部署了 kubelet）。</p>
</blockquote>
<h2 id="Kubernetes-如何使用-Etcd"><a href="#Kubernetes-如何使用-Etcd" class="headerlink" title="Kubernetes 如何使用 Etcd"></a>Kubernetes 如何使用 Etcd</h2><p>Etcd 是一个分布式、高可用的 kv 存储，唯一与 etcd 通信的就是 API 服务器，其他组件通过 API 服务器读写数据到 etcd 中，使用<strong>乐观锁</strong>机制进行<strong>并发</strong>写入控制。</p>
<blockquote>
<p><strong>Kubernetes API 服务器实现了乐观锁机制</strong>，所有资源都有一个 meta.resourceVersion 字段，当更新对象时，客户端返回这个值到 API 服务器，如果版本值与 etcd 不一致，则会拒绝更新。</p>
</blockquote>
<p>Kubernetes 将资源的完整 Json 形式都存储在 etcd 中，etcd 是层级存储结构，kubernetes 的所有资源数据都在 etcd 的 /registry 下。</p>
<h2 id="了解-API-服务器"><a href="#了解-API-服务器" class="headerlink" title="了解 API 服务器"></a>了解 API 服务器</h2><p>API 服务器提供了 Restful API，用于对 Kubernetes 集群中的资源进行 CRUD 操作，并且将资源状态持久化到 etcd 中。</p>
<h3 id="更改资源时-API-服务器做了什么"><a href="#更改资源时-API-服务器做了什么" class="headerlink" title="更改资源时 API 服务器做了什么"></a>更改资源时 API 服务器做了什么</h3><p>在 API 服务器收到一个 POST HTTP 请求后：</p>
<ul>
<li><strong>利用认证插件认证客户端。</strong>API 服务器轮询认证插件，直到有一个插件能够<strong>认证客户端身份</strong>，包括客户端的用户名、用户 ID、用户组。</li>
<li><strong>通过授权插件授权客户端。</strong>授权插件根据用户名、用户 ID、用户组来决定是否<strong>授权</strong>客户端的操作，授权插件也有多个。</li>
<li><strong>通过准入控制插件修改资源请求。</strong>如果尝试修改、新建、删除资源，需要经过准入控制插件的验证。准入控制插件会初始化资源定义中漏配的字段为默认值，甚至修改不在请求中的相关资源，同时也会因为某些原因拒绝一个请求。</li>
<li><strong>持久化。</strong>之后会将资源状态的改变持久化到 etcd 中，然后给客户端一个响应。</li>
</ul>
<p><img src="/../images/Kubernetes%E5%AD%A6%E4%B9%A0-9-%E4%BA%86%E8%A7%A3Kubernetes%E6%9C%BA%E7%90%86/image-20231003171103084.png" alt="image-20231003171103084"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/10/03/Kubernetes%E5%AD%A6%E4%B9%A0-9-%E4%BA%86%E8%A7%A3Kubernetes%E6%9C%BA%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/26/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-3-%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/26/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-3-%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/" class="post-title-link" itemprop="url">Istio学习笔记 (3) 可观测性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-26 20:14:05" itemprop="dateCreated datePublished" datetime="2023-09-26T20:14:05+08:00">2023-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-26 16:20:16" itemprop="dateModified" datetime="2024-02-26T16:20:16+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Istio学习笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>可观测性：</strong>为服务网格内的所有通信生成详细的<strong>遥测数据</strong>。这种遥测技术提供了服务行为的可观测性，使开发者能够排除故障、维护和优化其应用。 更好的是，它对于服务来说是<strong>透明</strong>的，不会为开发带来负担。</p>
<blockquote>
<p>Istio 的遥测技术包括详细的<strong>指标</strong>、<strong>分布式跟踪</strong>和完整的访问<strong>日志</strong>。</p>
</blockquote>
<h1 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h1><p>指标提供了一种以<strong>聚合</strong>的方式监控和理解行为的方法。</p>
<p>为了<strong>监控服务行为</strong>，Istio 为服务网格中所有出入网格， 以及网格内部的服务流量都生成了指标。除了监控网格中服务的行为外，<strong>监控网格本身的行为也很重要</strong>。 Istio 组件可以导出自身内部行为的指标， 以提供对网格控制平面的功能和健康情况的洞察能力。</p>
<h3 id="代理级别的指标"><a href="#代理级别的指标" class="headerlink" title="代理级别的指标"></a>代理级别的指标</h3><p>Istio 代理级别的指标从边车代理开始，每个代理为通过它的所有流量（入站和出站）生成一组丰富的指标。</p>
<p>Istio 此级别的指标，<strong>就是 Envoy 生成的</strong>统计信息指标。</p>
<h3 id="服务级别的指标"><a href="#服务级别的指标" class="headerlink" title="服务级别的指标"></a>服务级别的指标</h3><p>Istio 还提供了一组<strong>面向服务</strong>的指标。 这些指标涵盖了四个基本的服务监控需求：延迟、流量、错误和饱和情况。</p>
<p>默认情况下，标准 Istio 指标会导出到 Promethus 中，使用 Grafana 作为仪表盘。 </p>
<h3 id="控制平面指标"><a href="#控制平面指标" class="headerlink" title="控制平面指标"></a>控制平面指标</h3><p>Istio 控制平面还提供了一组自我监控指标，这些指标容许监控 Istio 自己的行为。</p>
<h1 id="分布式追踪"><a href="#分布式追踪" class="headerlink" title="分布式追踪"></a>分布式追踪</h1><p>分布式追踪通过<strong>监控流经网格的单个请求</strong>，提供了一种监控和理解行为的方法。 追踪使网格的运维人员能够理解服务的<strong>依赖关系</strong>以及在服务网格中的<strong>延迟源</strong>。</p>
<p>Istio 支持通过 Envoy 代理进行分布式追踪，支持多种追踪系统，包括 Zipkin、Jaeger、Datadog、LigitStep。</p>
<p>运维人员控制生成追踪的采样率，这允许运维人员控制网格生成追踪数据的数量和速率。</p>
<h1 id="访问日志"><a href="#访问日志" class="headerlink" title="访问日志"></a>访问日志</h1><p>访问日志提供了一种<strong>从单个工作负载实例的角度</strong>监控和理解行为的方法。</p>
<p>Istio 以一组<strong>可配置</strong>的格式，生成访问日志。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/26/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2-%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/26/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2-%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/" class="post-title-link" itemprop="url">Istio学习笔记 (2) 流量管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-26 15:37:25" itemprop="dateCreated datePublished" datetime="2023-09-26T15:37:25+08:00">2023-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-26 16:20:16" itemprop="dateModified" datetime="2024-02-26T16:20:16+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Istio学习笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Istio 的流量管理提供了以下功能：</p>
<ul>
<li><strong>路由规则：</strong>Istio 提供流量路由规则，可以控制服务之间的流量和 API 调用。</li>
<li><strong>简化服务级别属性的配置：</strong>提供熔断器、超时、重试机制，透明的为服务增加<strong>弹性</strong>。</li>
<li><strong>可设置重要任务：</strong>可以进行 A/B 测试、canary 部署和基于百分比流量分割的分阶段部署。</li>
<li><strong>开箱即用的故障恢复</strong>：使得应用更<strong>健壮</strong>地应对网络或者服务故障。</li>
</ul>
<h1 id="虚拟服务和目标规则"><a href="#虚拟服务和目标规则" class="headerlink" title="虚拟服务和目标规则"></a>虚拟服务和目标规则</h1><p>虚拟服务（Virtual Service）和目标规则（Destination Rule）是 Istio 流量路由功能的<strong>核心构建模块</strong>。</p>
<h2 id="虚拟服务"><a href="#虚拟服务" class="headerlink" title="虚拟服务"></a>虚拟服务</h2><p>VirtualService 旨在<strong>解耦</strong>客户端请求的地址与响应请求的目标工作负载。使用虚拟服务，可以为一个或者多个<strong>主机名（host）制定流量行为</strong>，可以使用<strong>路由规则</strong>，配置路由目标地址。</p>
<blockquote>
<p>如何理解客户的请求地址与实际响应的目标工作负载的<strong>解耦</strong>？</p>
<p> 客户端将虚拟服务视为一个<strong>单一实体</strong>，将请求发送至虚拟服务（这个过程中，客户的并不知道具体如何进行路由，<strong>它只知道一个虚拟服务的地址</strong>）， 然后 Envoy 根据虚拟服务规则把流量路由到不同的版本。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/26/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2-%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/25/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1-%E7%90%86%E8%A7%A3Istio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/25/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1-%E7%90%86%E8%A7%A3Istio/" class="post-title-link" itemprop="url">Istio学习笔记 (1) 理解Istio</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-25 19:53:06" itemprop="dateCreated datePublished" datetime="2023-09-25T19:53:06+08:00">2023-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-26 16:20:16" itemprop="dateModified" datetime="2024-02-26T16:20:16+08:00">2024-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">Istio学习笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Istio-介绍"><a href="#Istio-介绍" class="headerlink" title="Istio 介绍"></a>Istio 介绍</h1><h2 id="服务网格"><a href="#服务网格" class="headerlink" title="服务网格"></a>服务网格</h2><p>服务网格（Service mesh），作为<strong>服务间通信的基础设施层</strong>。与应用部署一起，但对应用<strong>透明</strong>。应用作为服务的发起方，只需要用最简单的方式将请求<strong>发送给本地的服务网格代理</strong>，然后网格代理会进行后续的操作，如服务发现，负载均衡，最后将请求转发给目标服务。</p>
<p><strong>服务网格目的是解决系统架构微服务化后的服务间通信和治理问题。</strong>服务网格由 Sidecar 节点组成，实现了数据面和控制面的解耦。服务网格的功能旨在实现以下方面：</p>
<ul>
<li><strong>流量控制：</strong>包括两个方面：<ul>
<li>流量管理：服务发现、服务注册、负载均衡、路由等。</li>
<li>弹性：超时、重试、熔断等。</li>
</ul>
</li>
<li><strong>可观测性：</strong>指标、分布式追踪、日志。</li>
<li><strong>安全性：</strong>服务间访问控制、加密通信。</li>
</ul>
<h2 id="Istio-是什么"><a href="#Istio-是什么" class="headerlink" title="Istio 是什么"></a>Istio 是什么</h2><p>Istio 是由谷歌、IBM 和 Lyft 创建的服务网格开源实现，以透明的方式向服务架构中添加流量控制、可观测性、安全性。Istio 由一个控制平面和基于 Envoy 的数据平面组成。</p>
<blockquote>
<p><strong>服务网格与 SOA 中企业服务总线（ESB）之间的关系：</strong></p>
<p>相同点：在架构中，不论是服务网格还是 ESB，对于应用来说都是透明的，应用程序不应该感知到。并且，ESB 与服务网格之间功能重合，如都提供重试、超时、熔断、服务发现、负载均衡。</p>
<p>不同点：</p>
<ul>
<li>ESB 非常集中化的部署，而服务网格是分布式的部署，sidecar 与应用程序一起被分布式的部署在集群中。</li>
<li>ESB 非常复杂，提供了业务转换、服务编排等不属于服务网格的职责，也就是 ESB 基于复杂的专有供应商软件。</li>
</ul>
<p><strong>服务网格和 API 网关之间的关系：</strong></p>
<p>相同点：都具有服务发现、可见性、安全、流量管理等特性（二者之间的用途有重叠）。</p>
<p>不同点：</p>
<ul>
<li>API Gateway 主要的作用是暴露 API 给外部，API 通过调用下游的组合或者单个微服务的方式，来提供业务逻辑。</li>
<li>而服务网格仅仅是服务之间的基础设施，不了解应用中的业务逻辑。</li>
</ul>
<p><strong>所以，可以将 API Gateway 和 Service Mesh 一起部署</strong>。API Gateway 负责应用逻辑，Service Mesh 负责服务发现、可见性等服务基础设施（可能会影响性能，多了本地连接的时间，但是可以通过水平扩展来弥补）。</p>
</blockquote>
<p><strong>数据平面</strong>通过<strong>代理（Envoy）</strong>拦截微服务架构集群中的所有网络流量，<strong>与每个服务一起部署</strong>，提供流量管理、可观测性等功能。</p>
<p><strong>控制平面</strong>提供 API 供运维人员配置数据平面，<strong>动态</strong>的对数据平面进行配置。</p>
<h2 id="基本特性"><a href="#基本特性" class="headerlink" title="基本特性"></a>基本特性</h2><p>Istio 透明的为微服务之间提供了三个特性，流量管理、可观测性、安全性。</p>
<h3 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h3><ul>
<li><strong>流量管理：</strong><ul>
<li><strong>路由规则：</strong>Istio 提供流量路由规则，可以控制服务之间的流量和 API 调用。</li>
<li><strong>简化服务级别属性的配置：</strong>提供熔断器、超时、重试机制，透明的为服务增加<strong>弹性</strong>。</li>
<li><strong>可设置重要任务：</strong>可以进行 A/B 测试、canary 部署和基于百分比流量分割的分阶段部署。</li>
<li><strong>开箱即用的故障恢复</strong>：使得应用更<strong>健壮</strong>地应对网络或者服务故障。</li>
</ul>
</li>
</ul>
<h3 id="可观测性"><a href="#可观测性" class="headerlink" title="可观测性"></a>可观测性</h3><ul>
<li><strong>可观测性：</strong>为服务网格内的所有通信生成详细的<strong>遥测数据</strong>。这种遥测技术提供了服务行为的可观测性，使开发者能够排除故障、维护和优化其应用。 更好的是，它对于服务来说是<strong>透明</strong>的，不会为开发带来负担。</li>
</ul>
<blockquote>
<p>Istio 的遥测技术包括详细的<strong>指标</strong>、<strong>分布式跟踪</strong>和完整的访问<strong>日志</strong>。</p>
</blockquote>
<h3 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h3><ul>
<li><strong>安全性：</strong>包括全面的安全解决方案，Istio 提供了强大的身份、强大的策略、透明的 TLS 加密，以及验证、授权和审计（AAA）工具来保护服务和数据。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/25/Istio%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1-%E7%90%86%E8%A7%A3Istio/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/21/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-4-Envoy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/21/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-4-Envoy/" class="post-title-link" itemprop="url">阅读dubbo-kubernetes的启发 (4) Envoy</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-21 21:25:00" itemprop="dateCreated datePublished" datetime="2023-09-21T21:25:00+08:00">2023-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dubbo-kubernetes/" itemprop="url" rel="index"><span itemprop="name">dubbo-kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Envoy-介绍"><a href="#Envoy-介绍" class="headerlink" title="Envoy 介绍"></a>Envoy 介绍</h1><p>Envoy 是由 C++ 实现的，为面向大型现代服务架构而<strong>设计的 L7 代理和通信总线</strong>。Envoy 是一个<strong>独立的进程</strong>，伴随每个应用服务运行（<strong>service mesh</strong>），所有的 Envoy 形成了一个透明的网络，每一个应用与 localhost 收发消息，而对网络拓扑结构无感知。这样做的好处：</p>
<ul>
<li>适用于任何编程语言。Envoy 可以在 Java、Go、Python 等应用程序之间形成一个网络，Envoy 弥合了它们之间的差异。</li>
<li>Envoy 可以透明地在整个基础架构上快速部署和升级。</li>
</ul>
<p>Envoy 在云原生中可以扮演<strong>边车</strong>的角色，所有到服务的流量都通过 Envoy 代理。</p>
<p><img src="/../images/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-4-Envoy/20200503110532.png" alt="img"></p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>Envoy 有以下功能/特点：</p>
<ul>
<li><strong>L3/L4/L7 架构：</strong>传统的网络代理要么在 HTTP 层工作，要么在 TCP 层工作。在 HTTP 层会读取整个 HTTP 请求数据，对请求解析并查看 HTTP 头部和 URL 以决定做什么；同时也需要读取后段的整个响应数据，并将其发送给客户端。这种方法非常复杂和缓慢，解决方法就是下沉到 TCP 中去操作。在 TCP 层只读取和写入字节，并使用 IP + 端口号来决定如何处理，但是无法根据不同的 URL 代理到不同的后端。Envoy 同时支持在 3/4 和 7 层工作，以此应对各自层级的限制。</li>
<li><strong>顶级 HTTP/2 支持：</strong>Envoy 将 HTTP/2 视为一等公民，支持 HTTP2 和 HTTP/1.1 之间的转换。</li>
<li><strong>服务发现和动态配置：</strong>Envoy 可以通过 API 来实现其控制平面（典型的，Istio 就是 Envoy 的一个控制面），控制平面可以实现服务发现并通过 API 接口动态更新 Envoy（数据面）的配置。不仅如此，控制平面还可以通过 API 将配置进行分层，然后逐层更新。</li>
<li><strong>gRPC 支持：</strong>Envoy 支持 HTTP/2，同时也支持 gRPC。</li>
<li><strong>特殊协议支持：</strong>Envoy 支持对特殊协议在 L7 进行嗅探，包括 MongoDB、DynamoDB 等。</li>
<li><strong>可观测性：</strong>Envoy 使网络透明，可以生成许多流量方面的统计数据，这是其它代理软件很难取代的地方，可以集成 Promethus 等监控方案、分布式追踪系统。</li>
</ul>
<h1 id="Envoy-架构"><a href="#Envoy-架构" class="headerlink" title="Envoy 架构"></a>Envoy 架构</h1><p>Envoy 使用<strong>单进程-多线程</strong>架构。一个主线处理与协调任务，多个 worker 线程负责监听、过滤、转发。 当一个连接被监听器接受，连接的剩余生命周期将<strong>绑定</strong>在当前 worker 线程，这<strong>使得 Envoy 近似于非阻塞</strong>。这使得 Envoy 大部分连接近似单线程运行（高度并行）， 只有少量的复杂代码用于实现 worker 线程之间的协调。</p>
<blockquote>
<p>所以，<strong>worker 线程数量应该配置为物理机的线程数量</strong>。</p>
<p>Envoy 同 Nginx 一样，也采用了多进程 + 非阻塞 + 异步 IO。</p>
</blockquote>
<p>默认情况下，worker 线程之间没有协调。这表示所有 worker 线程都独立的尝试从每一个监听器接受连接， 然后依赖内核在线程之间执行适当的均衡。对于大多数工作负载，内核都可以很好的均衡传入的连接。但是， 对于某些工作负载，特别是那些只有少量但非常长寿命的连接的工作负载（例如 gRPC 流）， 则可能希望让 Envoy 强制平衡工作线程之间的连接。为了支持这种行为， Envoy 允许为每个监听器配置不同类型的连接均衡。</p>
<p>下图为 Envoy 的架构图：</p>
<p><img src="/../images/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-4-Envoy/20200504160047.png" alt="img"></p>
<p>Envoy 有四个关键组件</p>
<ul>
<li><strong>监听器（Listener）：</strong> 监听器定义了 Envoy 如何<strong>处理连接请求</strong>，一旦建立连接之后，就会将该请求传递给一组过滤器（filter）进行处理。</li>
<li><strong>过滤器（Filter）：</strong> 过滤器是<strong>处理入站和出站流量</strong>的链式结构的一部分。在过滤器链上可以集成很多特定功能的过滤器，例如，通过集成 GZip 过滤器可以在数据发送到客户端之前压缩数据。</li>
<li><strong>路由（Router）：</strong> 路由用来将流量转发到具体的目标实例，目标实例在 Envoy 中被定义为集群。</li>
<li><strong>集群（Cluster）：</strong> 集群定义了流量的<strong>目标端点</strong>，同时还包括一些其他可选配置，如负载均衡策略等。</li>
</ul>
<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><p>Envoy 运行着一系列 Listener，Listener 的核心就是过滤器链（FilterChain）。过滤器链中的过滤器分为两个类别：</p>
<ul>
<li><strong>网络过滤器（L3/L4 层）：</strong>是 Envoy 网络连接处理的核心，处理的是原始字节，分为 Read、Write 和 Read/Write 三类。</li>
<li><strong>L7 过滤器：</strong>在 L3/L4 之上的过滤器，主要支持 HTTP 和 Thrift 协议。<ul>
<li><strong>HTTP 过滤器：</strong>由 HTTP connection manager 管理，专门处理 HTTP1/HTTP2/gRPC 协议，将原始字节转换成 HTTP 格式，从而对 HTTP 协议进行精准控制。</li>
<li><strong>Thrift Proxy：</strong>用于支持 Thrift 协议。</li>
</ul>
</li>
</ul>
<p>除了过滤器链之外，还有一种过滤器叫<strong>监听器过滤器</strong>（Listener Filters），它会在过滤器链之前执行，用于操纵连接的<strong>元数据</strong>。这样做的目的是，无需更改 Envoy 的核心代码就可以方便地集成更多功能。</p>
<p><img src="/../images/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-4-Envoy/20200504224710.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-3-OCI%E4%B8%8EBuildpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-3-OCI%E4%B8%8EBuildpack/" class="post-title-link" itemprop="url">阅读dubbo-kubernetes的启发 (3) OCI与Buildpack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-20 20:28:20" itemprop="dateCreated datePublished" datetime="2023-09-20T20:28:20+08:00">2023-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dubbo-kubernetes/" itemprop="url" rel="index"><span itemprop="name">dubbo-kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文内容不谈 dubbo-kubernetes，因为 dubbo-kubernetes 在构建镜像时可以使用 Buildpack 来构建 OCI 镜像，所以本文来谈一谈 Buildpack。</p>
<blockquote>
<p>dubboctl 在 build 镜像时可以选择 buildpack 或者 dockerfile 的方式。</p>
</blockquote>
<h1 id="OCI"><a href="#OCI" class="headerlink" title="OCI"></a>OCI</h1><p>随着 Kubernetes 成为了重启编排的事实标准，为了确保所有的容器运行时都都运行任何构建工具生成的镜像（而不仅仅是 Docker），OCI（Open Container Initiative）开放容器协议被提出，OCI 制定了围绕<strong>容器镜像格式（image-spec）</strong>和运行时（runtime-spec）的行业标准。<strong>给定一个 OCI 镜像</strong>，任何实现 OCI 运行时标准的容器运行时都可以<strong>使用</strong>该镜像运行容器。</p>
<blockquote>
<p><strong>Docker 镜像和 OCI 镜像有什么区别？</strong></p>
<p>答案是：几乎没有区别。有一部分旧的 Docker 镜像在 OCI 规范之前就已经存在了，它们被成为 Docker v1 规范，与 Docker v2 规范是不兼容的。而 Docker v2 规范捐给了 OCI，构成了 OCI 规范的基础。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-3-OCI%E4%B8%8EBuildpack/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-2-dubboctl%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E4%B8%8ERepository-Runtime-Template/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-2-dubboctl%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E4%B8%8ERepository-Runtime-Template/" class="post-title-link" itemprop="url">阅读dubbo-kubernetes的启发 (2) dubboctl客户端Client与Repository Runtime Template</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-20 17:25:34" itemprop="dateCreated datePublished" datetime="2023-09-20T17:25:34+08:00">2023-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dubbo-kubernetes/" itemprop="url" rel="index"><span itemprop="name">dubbo-kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><p>dubbo-kubernetes 的命令行工具 dubboctl 用于构建项目、打包成镜像、推送至 registry、部署 kubernetes 等。</p>
<p>而 dubboctl 的<strong>核心在于 Client，表示 dubboctl 客户端，执行 dubboctl 的各种操作</strong>。Client 定义在 app/dubboctl/internal/dubbo/client.go 文件中，其结构如下。其中，Client 包含了 builder、pusher、deployer 等组件，用于打包镜像、推送、部署工作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">    repositoriesPath <span class="keyword">string</span>          <span class="comment">// path to repositories</span></span><br><span class="line">    repositoriesURI  <span class="keyword">string</span>          <span class="comment">// repo URI (overrides repositories path)</span></span><br><span class="line">    templates        *Templates      <span class="comment">// Templates management</span></span><br><span class="line">    repositories     *Repositories   <span class="comment">// Repositories management</span></span><br><span class="line">    builder          Builder         <span class="comment">// Builds a runnable image source</span></span><br><span class="line">    pusher           Pusher          <span class="comment">// Pushes function image to a remote</span></span><br><span class="line">    deployer         Deployer        <span class="comment">// Deploys or Updates a function&#125;</span></span><br><span class="line">    KubeCtl          *kube.CtlClient <span class="comment">// Kube Client</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="初始化函数"><a href="#初始化函数" class="headerlink" title="初始化函数"></a>初始化函数</h2><p>New 用于初始化一个 Client，该函数根据配置 options 配置 Client，并且初始化 repository 和 template 管理器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New client for function management.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(options ...Option)</span> *<span class="title">Client</span></span> &#123;</span><br><span class="line">    <span class="comment">// Instantiate client with static defaults.</span></span><br><span class="line">    c := &amp;Client&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> _, o := <span class="keyword">range</span> options &#123;</span><br><span class="line">       o(c)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize sub-managers using now-fully-initialized client.</span></span><br><span class="line">    c.repositories = newRepositories(c)</span><br><span class="line">    c.templates = newTemplates(c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dubboctl-使用的默认初始化函数"><a href="#dubboctl-使用的默认初始化函数" class="headerlink" title="dubboctl 使用的默认初始化函数"></a>dubboctl 使用的默认初始化函数</h2><p>在 dubboctl 使用 Client 时，又封装了一<strong>个默认的初始化函数 NewClient，用于提供完整功能的 Client</strong>，包括配置：</p>
<ul>
<li>默认的本地 repository 地址，dubbo.WithRepositoriesPath。</li>
<li>Builder 镜像构造器，dubbo.WithBuilder。</li>
<li>Pusher 用于将镜像推送至 registry，dubbo.WithPusher。</li>
<li>Deployer 用于部署应用至 kubernetes，dubbo.WithDeployer。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClient</span><span class="params">(options ...dubbo.Option)</span> <span class="params">(*dubbo.Client, <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">       t = newTransport(<span class="literal">false</span>)</span><br><span class="line">       c = newCredentialsProvider(config.Dir(), t)</span><br><span class="line">       d = newDubboDeployer()</span><br><span class="line">       o = []dubbo.Option&#123;</span><br><span class="line">          dubbo.WithRepositoriesPath(config.RepositoriesPath()),</span><br><span class="line">          dubbo.WithBuilder(pack.NewBuilder()),</span><br><span class="line">          dubbo.WithPusher(docker.NewPusher(</span><br><span class="line">             docker.WithCredentialsProvider(c),</span><br><span class="line">             docker.WithTransport(t))),</span><br><span class="line">          dubbo.WithDeployer(d),</span><br><span class="line">       &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// Client is constructed with standard options plus any additional options</span></span><br><span class="line">    <span class="comment">// which either augment or override the defaults.</span></span><br><span class="line">    client := dubbo.New(<span class="built_in">append</span>(o, options...)...)</span><br><span class="line"></span><br><span class="line">    cleanup := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> client, cleanup</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三层结构"><a href="#三层结构" class="headerlink" title="三层结构"></a>三层结构</h1><p>在 dubboctl 创建应用时，支持<strong>自定义应用模版</strong>。而在 dubboctl 中有<strong>三层</strong>结构的概念，分别是 repository，runtime，template。</p>
<p>其中，repository 指的是一个仓库（可以是本地的或是远程的 git 仓库），而 runtime 指的是使用的编程语言，template 为创建应用的具体模版。</p>
<p>如默认仓库 default 的结构如下，有两种 runtime 分别是 go 和 java，而每一种 runtime 中又指定了一个名为 common 的模版。</p>
<p><img src="/../images/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-2-dubboctl%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E4%B8%8ERepository-Runtime-Template/image-20230920175155155.png" alt="image-20230920175155155"></p>
<blockquote>
<p>Repository Runtime Template 之间都是一对多的关系，一个 Repository 下有多个 Runtime，一个 Runtime 下有多个 Template。</p>
</blockquote>
<h2 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h2><p>Repository 被定义为存放 template 的仓库，这个仓库可以是本地的，也可以是远程的。<strong>至于 repository 是本地的还是远程的，取决于 uri</strong>，根据 uri 构造不同类型的文件系统，如上一篇文章所述，dubbo-kubernetes 抽象出了多种不同的文件系统。</p>
<blockquote>
<p>若 uri 以 file:// 为协议头，则表示这是一个本地仓库。</p>
<p>若 uri 为 git 远程地址，则表示这是一个远程 git repository。</p>
</blockquote>
<p>在 repository 的根目录下可以保存一个 manifes.yaml，用于保存 repository 的配置信息 repositoryConfig，包括名字、版本号（这个目前没有用到）、template 存放地址（默认在仓库的根目录下）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Repository represents a collection of runtimes, each containing templates.</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Name of the repository</span></span><br><span class="line">    <span class="comment">// This can be for instance:</span></span><br><span class="line">    <span class="comment">// directory name on FS or last part of git URL or arbitrary value defined by the Template author.</span></span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Runtimes containing Templates loaded from the repo</span></span><br><span class="line">    Runtimes []Runtime</span><br><span class="line">    fs       filesystem.Filesystem</span><br><span class="line">    uri      <span class="keyword">string</span> <span class="comment">// URI which was used when initially creating</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> repositoryConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// DefaultName is the name indicated by the repository author.</span></span><br><span class="line">    <span class="comment">// Stored in the yaml attribute &quot;name&quot;, it is only consulted during initial</span></span><br><span class="line">    <span class="comment">// addition of the repo as the default option.</span></span><br><span class="line">    DefaultName <span class="keyword">string</span> <span class="string">`yaml:&quot;name,omitempty&quot;`</span></span><br><span class="line">    <span class="comment">// Version of the repository.</span></span><br><span class="line">    Version <span class="keyword">string</span> <span class="string">`yaml:&quot;version,omitempty&quot;`</span></span><br><span class="line">    <span class="comment">// TemplatesPath defines an optional path within the repository at which</span></span><br><span class="line">    <span class="comment">// templates are stored.  By default this is the repository root.</span></span><br><span class="line">    TemplatesPath <span class="keyword">string</span> <span class="string">`yaml:&quot;templates,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Client 不直接操作 Repository，而是通过 Repository 管理器 Repositories 操作仓库。</p>
</blockquote>
<h2 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h2><p>Runtime 表示不同的语言，在 Repository 中维护了 Runtime 切片，在 Runtime 中维护了 Template 切片。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime is a division of templates within a repository of templates for a</span></span><br><span class="line"><span class="comment">// given runtime (source language plus environmentally available services</span></span><br><span class="line"><span class="comment">// and libraries)</span></span><br><span class="line"><span class="keyword">type</span> Runtime <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Name of the runtime</span></span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Templates defined for the runtime</span></span><br><span class="line">    Templates []Template</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Repository 中，读取 repositoryConfig.TempatesPath（默认为 Repository 根目录）下的所有子文件夹，每一个子文件夹的名称就是一个 Runtime：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repositoryRuntimes returns runtimes defined in this repository&#x27;s filesystem.</span></span><br><span class="line"><span class="comment">// The views are denormalized, using the parent repository&#x27;s values</span></span><br><span class="line"><span class="comment">// for inherited fields BuildConfig and HealthEndpoints as the default values</span></span><br><span class="line"><span class="comment">// for the runtimes and templates.  The runtimes and templates themselves can</span></span><br><span class="line"><span class="comment">// override these values by specifying new values in thir config files.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">repositoryRuntimes</span><span class="params">(fs filesystem.Filesystem, repoName <span class="keyword">string</span>, repoConfig repositoryConfig)</span> <span class="params">(runtimes []Runtime, err error)</span></span> &#123;</span><br><span class="line">    runtimes = []Runtime&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load runtimes</span></span><br><span class="line">    fis, err := fs.ReadDir(repoConfig.TemplatesPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, fi := <span class="keyword">range</span> fis &#123;</span><br><span class="line">       <span class="comment">// ignore files and hidden dirs</span></span><br><span class="line">       <span class="keyword">if</span> !fi.IsDir() || strings.HasPrefix(fi.Name(), <span class="string">&quot;.&quot;</span>) &#123;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Runtime, defaulted to values inherited from the repository</span></span><br><span class="line">       runtime := Runtime&#123;</span><br><span class="line">          Name: fi.Name(),</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Runtime Templates</span></span><br><span class="line">       <span class="comment">// Load from repo filesystem for runtime. Will inherit values from the</span></span><br><span class="line">       <span class="comment">// runtime such as BuildConfig, HealthEndpoints etc.</span></span><br><span class="line">       runtime.Templates, err = runtimeTemplates(fs, repoConfig.TemplatesPath, repoName, runtime.Name)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">       &#125;</span><br><span class="line">       runtimes = <span class="built_in">append</span>(runtimes, runtime)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h2><p>Template 表示某个应用模版，在创建应用时，最终的操作就是<strong>将模版复制到指定的文件夹下</strong>。template 维护了一个 filesystem.Filesystem，表示以当前模版为根目录的文件系统。</p>
<blockquote>
<p>在创建模版时，遍历 repositoryConfig.TemplatesPath/RuntimeName 下的每一个文件夹，文件夹的名字作为模版名字，<strong>使用 subFS 作为模版文件系统的实现</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Template, defaulted to values inherited from the runtime</span></span><br><span class="line">t := template&#123;</span><br><span class="line">    name:       fi.Name(),</span><br><span class="line">    repository: repoName,</span><br><span class="line">    runtime:    runtimeName,</span><br><span class="line">    fs:         filesystem.NewSubFS(path.Join(runtimePath, fi.Name()), fs),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Template is a function project template.</span></span><br><span class="line"><span class="comment">// It can be used to instantiate new function project.</span></span><br><span class="line"><span class="keyword">type</span> Template <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Name of this template.</span></span><br><span class="line">    Name() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Runtime for which this template applies.</span></span><br><span class="line">    Runtime() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Repository within which this template is contained.  Value is set to the</span></span><br><span class="line">    <span class="comment">// currently effective name of the repository, which may vary. It is user-</span></span><br><span class="line">    <span class="comment">// defined when the repository is added, and can be set to &quot;default&quot; when</span></span><br><span class="line">    <span class="comment">// the client is loaded in single repo mode. I.e. not canonical.</span></span><br><span class="line">    Repository() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Fullname is a calculated field of [repo]/[name] used</span></span><br><span class="line">    <span class="comment">// to uniquely reference a template which may share a name</span></span><br><span class="line">    <span class="comment">// with one in another repository.</span></span><br><span class="line">    Fullname() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Write updates fields of function f and writes project files to path pointed by f.Root.</span></span><br><span class="line">    Write(ctx context.Context, f *Dubbo) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// template default implementation</span></span><br><span class="line"><span class="keyword">type</span> template <span class="keyword">struct</span> &#123;</span><br><span class="line">    name       <span class="keyword">string</span></span><br><span class="line">    runtime    <span class="keyword">string</span></span><br><span class="line">    repository <span class="keyword">string</span></span><br><span class="line">    fs         filesystem.Filesystem</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><p>在写入时，使用了 maskingFS，用于<strong>屏蔽</strong>当前模版下的 manifest 文件（虽然现在 manifest 没有什么用，并没有起到配置 template 的作用）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t template)</span> <span class="title">Write</span><span class="params">(ctx context.Context, f *Dubbo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    mask := <span class="function"><span class="keyword">func</span><span class="params">(p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">       _, f := path.Split(p)</span><br><span class="line">       <span class="keyword">return</span> f == templateManifest</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filesystem.CopyFromFS(<span class="string">&quot;.&quot;</span>, f.Root, filesystem.NewMaskingFS(mask, t.fs)) <span class="comment">// copy everything but manifest.yaml</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-1-%E6%8A%BD%E8%B1%A1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-1-%E6%8A%BD%E8%B1%A1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">阅读dubbo-kubernetes的启发 (1) 抽象文件系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-20 11:12:46" itemprop="dateCreated datePublished" datetime="2023-09-20T11:12:46+08:00">2023-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dubbo-kubernetes/" itemprop="url" rel="index"><span itemprop="name">dubbo-kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="文件系统抽象"><a href="#文件系统抽象" class="headerlink" title="文件系统抽象"></a>文件系统抽象</h1><p>在 dubbo-kubernetes 中，利用 golang 提供的 fs 抽象接口，实现了多种不同文件系统。各种文件系统的实现在 <code>app/dubboctl/internal/filesystem</code> 文件夹下，首先定义了一个 Filesystem 接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Filesystem <span class="keyword">interface</span> &#123;</span><br><span class="line">	fs.ReadDirFS</span><br><span class="line">	fs.StatFS</span><br><span class="line">	Readlink(link <span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Filesystem 接口将访问 template 文件（至于什么是模版，可以不知道）的各种实现差异，封装到这个接口中。Filesystem 接口的实现包括以下：</p>
<ul>
<li><strong>zipFS：</strong>用于<strong>对 zip 压缩文件</strong>的读写，将 zip 压缩文件作为一个文件系统，压缩文件中的一个个被压缩的文件或者文件夹就是文件系统中的文件。</li>
<li><strong>billyFS：</strong>表示 git repo 中的文件系统，用于访问在<strong>远程 git 仓库</strong>中的 template。</li>
<li><strong>osFilesystem：</strong>由操作系统支持的文件系统，用于访问 template。</li>
<li><strong>subFS：</strong>表示 Filesystem 中的<strong>子目录</strong>，单独作为一个文件系统。</li>
<li><strong>maskingFS：</strong>基于 Filesystem，用于<strong>屏蔽</strong>某些文件的文件系统。</li>
</ul>
<blockquote>
<p>Golang 提供了 io.Reader 和 io.Writer 接口，抽象出对文件、字节流、socket 的读写。至于问什么提出这样的接口，将对象看作是文件一样读写，可以在 Linux 中找到启发：<strong>Linux 中，一切皆是文件</strong>。</p>
<p>在 1.6 中提供了 fs.FS 抽象文件系统抽象，既然很多对象可以被看作是对象，那么这些抽象的文件聚集起来，就可以抽象出文件系统。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-1-%E6%8A%BD%E8%B1%A1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/18/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%AE%9E%E6%97%B6%E5%BD%92%E5%9B%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/18/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%AE%9E%E6%97%B6%E5%BD%92%E5%9B%A0/" class="post-title-link" itemprop="url">用户增长-实时归因</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-18 10:26:36" itemprop="dateCreated datePublished" datetime="2023-09-18T10:26:36+08:00">2023-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-14 15:01:48" itemprop="dateModified" datetime="2024-03-14T15:01:48+08:00">2024-03-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF%E4%BD%93%E7%B3%BB/" itemprop="url" rel="index"><span itemprop="name">用户增长体系</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          这是一篇加密文章，需要密码才能继续阅读
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/18/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%AE%9E%E6%97%B6%E5%BD%92%E5%9B%A0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/14/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%A2%9E%E9%95%BF%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/14/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%A2%9E%E9%95%BF%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/" class="post-title-link" itemprop="url">用户增长-增长平台业务梳理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-14 20:29:42" itemprop="dateCreated datePublished" datetime="2023-09-14T20:29:42+08:00">2023-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF%E4%BD%93%E7%B3%BB/" itemprop="url" rel="index"><span itemprop="name">用户增长体系</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          这是一篇加密文章，需要密码才能继续阅读
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/14/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%A2%9E%E9%95%BF%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DawnZH</p>
  <div class="site-description" itemprop="description">个人博客站点</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">415</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">53</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">51</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DawnZH</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
