<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"dawnzzz.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="个人博客站点">
<meta property="og:type" content="website">
<meta property="og:title" content="Dawn&#39;s Blogs">
<meta property="og:url" content="http://dawnzzz.github.io/page/8/index.html">
<meta property="og:site_name" content="Dawn&#39;s Blogs">
<meta property="og:description" content="个人博客站点">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="DawnZH">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://dawnzzz.github.io/page/8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Dawn's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Dawn's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">分享技术 记录成长</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-2-dubboctl%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E4%B8%8ERepository-Runtime-Template/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-2-dubboctl%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E4%B8%8ERepository-Runtime-Template/" class="post-title-link" itemprop="url">阅读dubbo-kubernetes的启发 (2) dubboctl客户端Client与Repository Runtime Template</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-20 17:25:34" itemprop="dateCreated datePublished" datetime="2023-09-20T17:25:34+08:00">2023-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dubbo-kubernetes/" itemprop="url" rel="index"><span itemprop="name">dubbo-kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><p>dubbo-kubernetes 的命令行工具 dubboctl 用于构建项目、打包成镜像、推送至 registry、部署 kubernetes 等。</p>
<p>而 dubboctl 的<strong>核心在于 Client，表示 dubboctl 客户端，执行 dubboctl 的各种操作</strong>。Client 定义在 app/dubboctl/internal/dubbo/client.go 文件中，其结构如下。其中，Client 包含了 builder、pusher、deployer 等组件，用于打包镜像、推送、部署工作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">    repositoriesPath <span class="keyword">string</span>          <span class="comment">// path to repositories</span></span><br><span class="line">    repositoriesURI  <span class="keyword">string</span>          <span class="comment">// repo URI (overrides repositories path)</span></span><br><span class="line">    templates        *Templates      <span class="comment">// Templates management</span></span><br><span class="line">    repositories     *Repositories   <span class="comment">// Repositories management</span></span><br><span class="line">    builder          Builder         <span class="comment">// Builds a runnable image source</span></span><br><span class="line">    pusher           Pusher          <span class="comment">// Pushes function image to a remote</span></span><br><span class="line">    deployer         Deployer        <span class="comment">// Deploys or Updates a function&#125;</span></span><br><span class="line">    KubeCtl          *kube.CtlClient <span class="comment">// Kube Client</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="初始化函数"><a href="#初始化函数" class="headerlink" title="初始化函数"></a>初始化函数</h2><p>New 用于初始化一个 Client，该函数根据配置 options 配置 Client，并且初始化 repository 和 template 管理器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// New client for function management.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(options ...Option)</span> *<span class="title">Client</span></span> &#123;</span><br><span class="line">    <span class="comment">// Instantiate client with static defaults.</span></span><br><span class="line">    c := &amp;Client&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> _, o := <span class="keyword">range</span> options &#123;</span><br><span class="line">       o(c)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize sub-managers using now-fully-initialized client.</span></span><br><span class="line">    c.repositories = newRepositories(c)</span><br><span class="line">    c.templates = newTemplates(c)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dubboctl-使用的默认初始化函数"><a href="#dubboctl-使用的默认初始化函数" class="headerlink" title="dubboctl 使用的默认初始化函数"></a>dubboctl 使用的默认初始化函数</h2><p>在 dubboctl 使用 Client 时，又封装了一<strong>个默认的初始化函数 NewClient，用于提供完整功能的 Client</strong>，包括配置：</p>
<ul>
<li>默认的本地 repository 地址，dubbo.WithRepositoriesPath。</li>
<li>Builder 镜像构造器，dubbo.WithBuilder。</li>
<li>Pusher 用于将镜像推送至 registry，dubbo.WithPusher。</li>
<li>Deployer 用于部署应用至 kubernetes，dubbo.WithDeployer。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClient</span><span class="params">(options ...dubbo.Option)</span> <span class="params">(*dubbo.Client, <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">       t = newTransport(<span class="literal">false</span>)</span><br><span class="line">       c = newCredentialsProvider(config.Dir(), t)</span><br><span class="line">       d = newDubboDeployer()</span><br><span class="line">       o = []dubbo.Option&#123;</span><br><span class="line">          dubbo.WithRepositoriesPath(config.RepositoriesPath()),</span><br><span class="line">          dubbo.WithBuilder(pack.NewBuilder()),</span><br><span class="line">          dubbo.WithPusher(docker.NewPusher(</span><br><span class="line">             docker.WithCredentialsProvider(c),</span><br><span class="line">             docker.WithTransport(t))),</span><br><span class="line">          dubbo.WithDeployer(d),</span><br><span class="line">       &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// Client is constructed with standard options plus any additional options</span></span><br><span class="line">    <span class="comment">// which either augment or override the defaults.</span></span><br><span class="line">    client := dubbo.New(<span class="built_in">append</span>(o, options...)...)</span><br><span class="line"></span><br><span class="line">    cleanup := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> client, cleanup</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三层结构"><a href="#三层结构" class="headerlink" title="三层结构"></a>三层结构</h1><p>在 dubboctl 创建应用时，支持<strong>自定义应用模版</strong>。而在 dubboctl 中有<strong>三层</strong>结构的概念，分别是 repository，runtime，template。</p>
<p>其中，repository 指的是一个仓库（可以是本地的或是远程的 git 仓库），而 runtime 指的是使用的编程语言，template 为创建应用的具体模版。</p>
<p>如默认仓库 default 的结构如下，有两种 runtime 分别是 go 和 java，而每一种 runtime 中又指定了一个名为 common 的模版。</p>
<p><img src="/../images/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-2-dubboctl%E5%AE%A2%E6%88%B7%E7%AB%AFClient%E4%B8%8ERepository-Runtime-Template/image-20230920175155155.png" alt="image-20230920175155155"></p>
<blockquote>
<p>Repository Runtime Template 之间都是一对多的关系，一个 Repository 下有多个 Runtime，一个 Runtime 下有多个 Template。</p>
</blockquote>
<h2 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h2><p>Repository 被定义为存放 template 的仓库，这个仓库可以是本地的，也可以是远程的。<strong>至于 repository 是本地的还是远程的，取决于 uri</strong>，根据 uri 构造不同类型的文件系统，如上一篇文章所述，dubbo-kubernetes 抽象出了多种不同的文件系统。</p>
<blockquote>
<p>若 uri 以 file:// 为协议头，则表示这是一个本地仓库。</p>
<p>若 uri 为 git 远程地址，则表示这是一个远程 git repository。</p>
</blockquote>
<p>在 repository 的根目录下可以保存一个 manifes.yaml，用于保存 repository 的配置信息 repositoryConfig，包括名字、版本号（这个目前没有用到）、template 存放地址（默认在仓库的根目录下）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Repository represents a collection of runtimes, each containing templates.</span></span><br><span class="line"><span class="keyword">type</span> Repository <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Name of the repository</span></span><br><span class="line">    <span class="comment">// This can be for instance:</span></span><br><span class="line">    <span class="comment">// directory name on FS or last part of git URL or arbitrary value defined by the Template author.</span></span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Runtimes containing Templates loaded from the repo</span></span><br><span class="line">    Runtimes []Runtime</span><br><span class="line">    fs       filesystem.Filesystem</span><br><span class="line">    uri      <span class="keyword">string</span> <span class="comment">// URI which was used when initially creating</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> repositoryConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// DefaultName is the name indicated by the repository author.</span></span><br><span class="line">    <span class="comment">// Stored in the yaml attribute &quot;name&quot;, it is only consulted during initial</span></span><br><span class="line">    <span class="comment">// addition of the repo as the default option.</span></span><br><span class="line">    DefaultName <span class="keyword">string</span> <span class="string">`yaml:&quot;name,omitempty&quot;`</span></span><br><span class="line">    <span class="comment">// Version of the repository.</span></span><br><span class="line">    Version <span class="keyword">string</span> <span class="string">`yaml:&quot;version,omitempty&quot;`</span></span><br><span class="line">    <span class="comment">// TemplatesPath defines an optional path within the repository at which</span></span><br><span class="line">    <span class="comment">// templates are stored.  By default this is the repository root.</span></span><br><span class="line">    TemplatesPath <span class="keyword">string</span> <span class="string">`yaml:&quot;templates,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Client 不直接操作 Repository，而是通过 Repository 管理器 Repositories 操作仓库。</p>
</blockquote>
<h2 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h2><p>Runtime 表示不同的语言，在 Repository 中维护了 Runtime 切片，在 Runtime 中维护了 Template 切片。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Runtime is a division of templates within a repository of templates for a</span></span><br><span class="line"><span class="comment">// given runtime (source language plus environmentally available services</span></span><br><span class="line"><span class="comment">// and libraries)</span></span><br><span class="line"><span class="keyword">type</span> Runtime <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Name of the runtime</span></span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Templates defined for the runtime</span></span><br><span class="line">    Templates []Template</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Repository 中，读取 repositoryConfig.TempatesPath（默认为 Repository 根目录）下的所有子文件夹，每一个子文件夹的名称就是一个 Runtime：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// repositoryRuntimes returns runtimes defined in this repository&#x27;s filesystem.</span></span><br><span class="line"><span class="comment">// The views are denormalized, using the parent repository&#x27;s values</span></span><br><span class="line"><span class="comment">// for inherited fields BuildConfig and HealthEndpoints as the default values</span></span><br><span class="line"><span class="comment">// for the runtimes and templates.  The runtimes and templates themselves can</span></span><br><span class="line"><span class="comment">// override these values by specifying new values in thir config files.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">repositoryRuntimes</span><span class="params">(fs filesystem.Filesystem, repoName <span class="keyword">string</span>, repoConfig repositoryConfig)</span> <span class="params">(runtimes []Runtime, err error)</span></span> &#123;</span><br><span class="line">    runtimes = []Runtime&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load runtimes</span></span><br><span class="line">    fis, err := fs.ReadDir(repoConfig.TemplatesPath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> _, fi := <span class="keyword">range</span> fis &#123;</span><br><span class="line">       <span class="comment">// ignore files and hidden dirs</span></span><br><span class="line">       <span class="keyword">if</span> !fi.IsDir() || strings.HasPrefix(fi.Name(), <span class="string">&quot;.&quot;</span>) &#123;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Runtime, defaulted to values inherited from the repository</span></span><br><span class="line">       runtime := Runtime&#123;</span><br><span class="line">          Name: fi.Name(),</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Runtime Templates</span></span><br><span class="line">       <span class="comment">// Load from repo filesystem for runtime. Will inherit values from the</span></span><br><span class="line">       <span class="comment">// runtime such as BuildConfig, HealthEndpoints etc.</span></span><br><span class="line">       runtime.Templates, err = runtimeTemplates(fs, repoConfig.TemplatesPath, repoName, runtime.Name)</span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">       &#125;</span><br><span class="line">       runtimes = <span class="built_in">append</span>(runtimes, runtime)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h2><p>Template 表示某个应用模版，在创建应用时，最终的操作就是<strong>将模版复制到指定的文件夹下</strong>。template 维护了一个 filesystem.Filesystem，表示以当前模版为根目录的文件系统。</p>
<blockquote>
<p>在创建模版时，遍历 repositoryConfig.TemplatesPath/RuntimeName 下的每一个文件夹，文件夹的名字作为模版名字，<strong>使用 subFS 作为模版文件系统的实现</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Template, defaulted to values inherited from the runtime</span></span><br><span class="line">t := template&#123;</span><br><span class="line">    name:       fi.Name(),</span><br><span class="line">    repository: repoName,</span><br><span class="line">    runtime:    runtimeName,</span><br><span class="line">    fs:         filesystem.NewSubFS(path.Join(runtimePath, fi.Name()), fs),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Template is a function project template.</span></span><br><span class="line"><span class="comment">// It can be used to instantiate new function project.</span></span><br><span class="line"><span class="keyword">type</span> Template <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Name of this template.</span></span><br><span class="line">    Name() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Runtime for which this template applies.</span></span><br><span class="line">    Runtime() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Repository within which this template is contained.  Value is set to the</span></span><br><span class="line">    <span class="comment">// currently effective name of the repository, which may vary. It is user-</span></span><br><span class="line">    <span class="comment">// defined when the repository is added, and can be set to &quot;default&quot; when</span></span><br><span class="line">    <span class="comment">// the client is loaded in single repo mode. I.e. not canonical.</span></span><br><span class="line">    Repository() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Fullname is a calculated field of [repo]/[name] used</span></span><br><span class="line">    <span class="comment">// to uniquely reference a template which may share a name</span></span><br><span class="line">    <span class="comment">// with one in another repository.</span></span><br><span class="line">    Fullname() <span class="keyword">string</span></span><br><span class="line">    <span class="comment">// Write updates fields of function f and writes project files to path pointed by f.Root.</span></span><br><span class="line">    Write(ctx context.Context, f *Dubbo) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// template default implementation</span></span><br><span class="line"><span class="keyword">type</span> template <span class="keyword">struct</span> &#123;</span><br><span class="line">    name       <span class="keyword">string</span></span><br><span class="line">    runtime    <span class="keyword">string</span></span><br><span class="line">    repository <span class="keyword">string</span></span><br><span class="line">    fs         filesystem.Filesystem</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><p>在写入时，使用了 maskingFS，用于<strong>屏蔽</strong>当前模版下的 manifest 文件（虽然现在 manifest 没有什么用，并没有起到配置 template 的作用）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t template)</span> <span class="title">Write</span><span class="params">(ctx context.Context, f *Dubbo)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    mask := <span class="function"><span class="keyword">func</span><span class="params">(p <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">       _, f := path.Split(p)</span><br><span class="line">       <span class="keyword">return</span> f == templateManifest</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filesystem.CopyFromFS(<span class="string">&quot;.&quot;</span>, f.Root, filesystem.NewMaskingFS(mask, t.fs)) <span class="comment">// copy everything but manifest.yaml</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-1-%E6%8A%BD%E8%B1%A1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-1-%E6%8A%BD%E8%B1%A1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">阅读dubbo-kubernetes的启发 (1) 抽象文件系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-20 11:12:46" itemprop="dateCreated datePublished" datetime="2023-09-20T11:12:46+08:00">2023-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dubbo-kubernetes/" itemprop="url" rel="index"><span itemprop="name">dubbo-kubernetes</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="文件系统抽象"><a href="#文件系统抽象" class="headerlink" title="文件系统抽象"></a>文件系统抽象</h1><p>在 dubbo-kubernetes 中，利用 golang 提供的 fs 抽象接口，实现了多种不同文件系统。各种文件系统的实现在 <code>app/dubboctl/internal/filesystem</code> 文件夹下，首先定义了一个 Filesystem 接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Filesystem <span class="keyword">interface</span> &#123;</span><br><span class="line">	fs.ReadDirFS</span><br><span class="line">	fs.StatFS</span><br><span class="line">	Readlink(link <span class="keyword">string</span>) (<span class="keyword">string</span>, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Filesystem 接口将访问 template 文件（至于什么是模版，可以不知道）的各种实现差异，封装到这个接口中。Filesystem 接口的实现包括以下：</p>
<ul>
<li><strong>zipFS：</strong>用于<strong>对 zip 压缩文件</strong>的读写，将 zip 压缩文件作为一个文件系统，压缩文件中的一个个被压缩的文件或者文件夹就是文件系统中的文件。</li>
<li><strong>billyFS：</strong>表示 git repo 中的文件系统，用于访问在<strong>远程 git 仓库</strong>中的 template。</li>
<li><strong>osFilesystem：</strong>由操作系统支持的文件系统，用于访问 template。</li>
<li><strong>subFS：</strong>表示 Filesystem 中的<strong>子目录</strong>，单独作为一个文件系统。</li>
<li><strong>maskingFS：</strong>基于 Filesystem，用于<strong>屏蔽</strong>某些文件的文件系统。</li>
</ul>
<blockquote>
<p>Golang 提供了 io.Reader 和 io.Writer 接口，抽象出对文件、字节流、socket 的读写。至于问什么提出这样的接口，将对象看作是文件一样读写，可以在 Linux 中找到启发：<strong>Linux 中，一切皆是文件</strong>。</p>
<p>在 1.6 中提供了 fs.FS 抽象文件系统抽象，既然很多对象可以被看作是对象，那么这些抽象的文件聚集起来，就可以抽象出文件系统。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/20/%E9%98%85%E8%AF%BBdubbo-kubernetes%E7%9A%84%E5%90%AF%E5%8F%91-1-%E6%8A%BD%E8%B1%A1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/18/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%AE%9E%E6%97%B6%E5%BD%92%E5%9B%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/18/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%AE%9E%E6%97%B6%E5%BD%92%E5%9B%A0/" class="post-title-link" itemprop="url">用户增长-实时归因</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-18 10:26:36" itemprop="dateCreated datePublished" datetime="2023-09-18T10:26:36+08:00">2023-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF%E4%BD%93%E7%B3%BB/" itemprop="url" rel="index"><span itemprop="name">用户增长体系</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          这是一篇加密文章，需要密码才能继续阅读
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/18/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%AE%9E%E6%97%B6%E5%BD%92%E5%9B%A0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/09/14/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%A2%9E%E9%95%BF%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/14/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%A2%9E%E9%95%BF%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/" class="post-title-link" itemprop="url">用户增长-增长平台业务梳理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-14 20:29:42" itemprop="dateCreated datePublished" datetime="2023-09-14T20:29:42+08:00">2023-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF%E4%BD%93%E7%B3%BB/" itemprop="url" rel="index"><span itemprop="name">用户增长体系</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          这是一篇加密文章，需要密码才能继续阅读
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/09/14/%E7%94%A8%E6%88%B7%E5%A2%9E%E9%95%BF-%E5%A2%9E%E9%95%BF%E5%B9%B3%E5%8F%B0%E4%B8%9A%E5%8A%A1%E6%A2%B3%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-4-%E7%B4%A2%E5%BC%95%E5%92%8C%E5%85%B3%E7%B3%BB%E5%BC%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-4-%E7%B4%A2%E5%BC%95%E5%92%8C%E5%85%B3%E7%B3%BB%E5%BC%95%E7%94%A8/" class="post-title-link" itemprop="url">MongoDB学习 (4) 索引和关系引用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-28 16:54:46" itemprop="dateCreated datePublished" datetime="2023-08-28T16:54:46+08:00">2023-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">MongoDB学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>MongoDB 支持建立索引，索引可以建立在一个或者多个字段上。并且由于索引是在内存中的，所以查询效率很高。但是在写操作时，由于还需要维护索引，所以写操作的效率会有所降低。</p>
<blockquote>
<p>MongoDB 索引的数据结构<strong>是 B 树</strong>。</p>
</blockquote>
<h2 id="索引覆盖查询"><a href="#索引覆盖查询" class="headerlink" title="索引覆盖查询"></a>索引覆盖查询</h2><p><strong>索引覆盖查询</strong>就是之间在索引上查询并返回结果，不需要在磁盘上扫描结果。索引覆盖查询需要满足以下条件：</p>
<ul>
<li>索引字段包含了查询条件中的所有字段。</li>
<li>查询条件中只包含索引字段，不包含其他字段。</li>
<li>查询结果只需要索引字段的值，不需要其他字段的值。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// users有三个字段name，gender，email</span></span><br><span class="line"><span class="comment">// 在name和gender字段上建立索引</span></span><br><span class="line"><span class="comment">// 仅仅查询gender字段，没有排除_id，查询就不会被覆盖</span></span><br><span class="line">db.users.find(&#123;<span class="attr">gender</span>:<span class="string">&quot;M&quot;</span>&#125;,&#123;<span class="attr">user_name</span>:<span class="number">1</span>,<span class="attr">_id</span>:<span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于索引覆盖查询来说，不会去数据库文件中去查找，而是<strong>在索引中直接提取数据</strong>。</p>
</blockquote>
<h1 id="关系"><a href="#关系" class="headerlink" title="关系"></a>关系</h1><p>在 MongoDB 中，可以表示一对一、一对多、多对一、多对多关系。</p>
<p>对于一对多关系，可以有两种方法：</p>
<ul>
<li><strong>嵌入完整的文档：</strong>在更新时需要非常的小心，需要同时更新所有嵌入的完整文档。同时冗余数据多，数据量不断变大，会影响读写性能。</li>
<li><strong>关系引用：</strong>通过引用文档的 _id 字段来建立关系。也就是说，MongoDB 支持在文档中引用其他文档。</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>在 MongoDB 中，数据库引用有两种方式：手动引用和DBRefs。</p>
<p>手动引用就是直接去在对应的字段中记录 _id 信息。</p>
<p>DBRefs 的形式为 <code>&#123; $ref : , $id : , $db :  &#125;</code>。三个字段表示的意义如下：</p>
<ul>
<li>$ref：集合名称。</li>
<li>$id：引用的 _id。</li>
<li>$db：引用的数据库名称，可选参数。</li>
</ul>
<blockquote>
<p>因为 DBRefs 可以指定引用的 id 和数据库名称，所以更加相比于手动引用更加规范和灵活。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-3-%E5%A4%8D%E5%88%B6%E5%92%8C%E5%88%86%E7%89%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-3-%E5%A4%8D%E5%88%B6%E5%92%8C%E5%88%86%E7%89%87/" class="post-title-link" itemprop="url">MongoDB学习 (3) 复制和分片</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-28 15:57:24" itemprop="dateCreated datePublished" datetime="2023-08-28T15:57:24+08:00">2023-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">MongoDB学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h1><p>复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</p>
<p>MongoDB 的数据复制至少需要两个节点，<strong>一个主节点，其余的节点为从节点（称为副本集）</strong>。主节点记录在其上的所有操作 oplog，<strong>从节点定期轮询</strong>主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致。</p>
<p><img src="/../images/MongoDB%E5%AD%A6%E4%B9%A0-3-%E5%A4%8D%E5%88%B6%E5%92%8C%E5%88%86%E7%89%87/replication.png" alt="MongoDB复制结构图"></p>
<p>在 MongoDB 中，副本集中所有的<strong>写操作都在主节点上进行</strong>，任何一个节点都可以称为主节点，并且可以<strong>自动故障转移</strong>和<strong>自动恢复</strong>。</p>
<h1 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h1><p>在 MongoDB 中也可以进行分片，分片可以提高数据的吞吐量。一个分片集群结构如下，包含三个部分：</p>
<ul>
<li><strong>Shard：</strong>用于存储实际的数据块，实际生产环境中一个 shard server 角色可由几台机器组成个一个 replica set 承担，防止主机单点故障。</li>
<li><strong>Config Server：</strong>MongoDB服务器实例，存储了整个集群的元信息。</li>
<li><strong>Query Routers：</strong>客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。</li>
</ul>
<p><img src="/../images/MongoDB%E5%AD%A6%E4%B9%A0-3-%E5%A4%8D%E5%88%B6%E5%92%8C%E5%88%86%E7%89%87/sharding.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-2-%E6%95%B0%E6%8D%AE%E5%BA%93-%E9%9B%86%E5%90%88-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-2-%E6%95%B0%E6%8D%AE%E5%BA%93-%E9%9B%86%E5%90%88-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C/" class="post-title-link" itemprop="url">MongoDB学习 (2) 数据库 集合 文档操作</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-28 14:51:23" itemprop="dateCreated datePublished" datetime="2023-08-28T14:51:23+08:00">2023-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">MongoDB学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h1><h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>在 MongoDB 中，使用 use 命令并且插入一条数据，就可以完成创建一个数据库了。</p>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><p>使用 db.dropDatabase() 删除数据库。</p>
<h1 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h1><h2 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h2><p>在 MongoDB 中，当插入文档时会<strong>自动</strong>的创建集合。</p>
<p>使用 createCollection 方法显式的创建集合。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(name, options)</span><br></pre></td></tr></table></figure>

<p>options 可以是如下参数：</p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">capped</td>
<td align="left">布尔</td>
<td align="left">（可选）如果为 true，则创建固定集合。固定集合是指有着固定大小的集合，当达到最大值时，它会自动覆盖最早的文档。 <strong>当该值为 true 时，必须指定 size 参数。</strong></td>
</tr>
<tr>
<td align="left">autoIndexId</td>
<td align="left">布尔</td>
<td align="left">3.2 之后不再支持该参数。（可选）如为 true，自动在 _id 字段创建索引。默认为 false。</td>
</tr>
<tr>
<td align="left">size</td>
<td align="left">数值</td>
<td align="left">（可选）为固定集合指定一个最大值，即字节数。 <strong>如果 capped 为 true，也需要指定该字段。</strong></td>
</tr>
<tr>
<td align="left">max</td>
<td align="left">数值</td>
<td align="left">（可选）指定固定集合中包含文档的最大数量。</td>
</tr>
</tbody></table>
<h2 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h2><p>使用 db.COLLECTION_NAME.drop() 删除集合。</p>
<h1 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h1><p>MongoDB 针对文档，同样支持增删改查操作，这里特别说明一下查询文档。</p>
<h2 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h2><p>使用 db.COLLECTION_NAME.find 方法查询文档，find 内部可以填写查询条件。如果需要以易读的方式来读取数据，可以使用 pretty() 方法。如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.col.find(&#123;</span><br><span class="line">	&quot;likes&quot;: &#123;$gt:50&#125;, </span><br><span class="line">	$or: [</span><br><span class="line">		&#123;&quot;by&quot;: &quot;xxx&quot;&#125;,</span><br><span class="line">		&#123;&quot;title&quot;: &quot;MongoDB学习&quot;&#125;</span><br><span class="line">		]</span><br><span class="line">	&#125;</span><br><span class="line">).pretty()</span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-2-%E6%95%B0%E6%8D%AE%E5%BA%93-%E9%9B%86%E5%90%88-%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" class="post-title-link" itemprop="url">MongoDB学习 (1) 基础概念</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-28 11:28:24" itemprop="dateCreated datePublished" datetime="2023-08-28T11:28:24+08:00">2023-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MongoDB%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">MongoDB学习</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="介绍-MongoDB"><a href="#介绍-MongoDB" class="headerlink" title="介绍 MongoDB"></a>介绍 MongoDB</h1><p>MongoDB 是一个由 C++ 编写的，<strong>分布式文档型数据库</strong>。在高负载的情况下，可以添加更多的节点，可以保证服务器性能。MongoDB 将数据存储为一个文档，数据结构由<strong>键值对</strong>构成，MongoDB 文档类似于 JSON 对象。字段值可以包含字面量，其他文档，数组及文档数组。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>MongoDB 的特点是：</p>
<ul>
<li>支持索引，利用索引可以实现更快的排序。</li>
<li>支持数据分片和数据复制，也就是具备分布式能力。</li>
<li>支持 Map/Reduce，用于对数据进行批量的处理和聚合操作。</li>
<li>允许在服务器端执行 Javascript 脚本。</li>
</ul>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>在 mongodb 中，最基本的概念就是文档、集合、数据库。</p>
<table>
<thead>
<tr>
<th align="left">SQL术语/概念</th>
<th align="left">MongoDB术语/概念</th>
<th align="left">解释/说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">database</td>
<td align="left">database</td>
<td align="left">数据库</td>
</tr>
<tr>
<td align="left">table</td>
<td align="left">collection</td>
<td align="left">数据库表/集合</td>
</tr>
<tr>
<td align="left">row</td>
<td align="left">document</td>
<td align="left">数据记录行/文档</td>
</tr>
<tr>
<td align="left">column</td>
<td align="left">field</td>
<td align="left">数据字段/域</td>
</tr>
<tr>
<td align="left">index</td>
<td align="left">index</td>
<td align="left">索引</td>
</tr>
<tr>
<td align="left">table joins</td>
<td align="left"></td>
<td align="left">表连接，MongoDB不支持</td>
</tr>
<tr>
<td align="left">primary key</td>
<td align="left">primary key</td>
<td align="left">主键，MongoDB自动将_id字段设置为主键</td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/08/28/MongoDB%E5%AD%A6%E4%B9%A0-1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/08/06/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-5-%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/06/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-5-%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA/" class="post-title-link" itemprop="url">数据密集型应用系统设计 (5) 数据分区</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-06 23:04:37" itemprop="dateCreated datePublished" datetime="2023-08-06T23:04:37+08:00">2023-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">数据密集型应用系统设计</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本节首先会介绍数据集<strong>切分的方法</strong>，并讨论索引和分片的配合；然后将会讨论分片<strong>再平衡</strong>（rebalancing），集群节点增删会引起数据再平衡；最后，会探讨数据库如何将请求<strong>路由</strong>到相应的分片并执行。</p>
<h1 id="分片方法"><a href="#分片方法" class="headerlink" title="分片方法"></a>分片方法</h1><p>分片方法都是基于<strong>键值对</strong>的，键值对是数据的一种最通用、泛化的表示，其他种类数据库都可以转化为键值对表示：</p>
<ul>
<li>关系型数据库：primary key → row</li>
<li>文档型数据库：document id → document</li>
<li>图数据库：vertex id → vertex，edge id → edge</li>
</ul>
<p>所以数据分片的基本方法就是，首先<strong>将数据转化为键值对，然后进行分区</strong>。<strong>分片（Partition）</strong> 的本质是对数据集合的划分，可以分为两个步骤：</p>
<ul>
<li>对数据集进行<strong>逻辑</strong>划分。</li>
<li>将逻辑分片<strong>调度到物理节点</strong>上。</li>
</ul>
<p>本节介绍逻辑划分方法，分别是按照键范围分区和按键散列分区。</p>
<h2 id="按键范围分区"><a href="#按键范围分区" class="headerlink" title="按键范围分区"></a>按键范围分区</h2><p>将该连续的定义域进行切分，每个分区内可以按照关键字排序保存（SSLTable）。保存每个切分的上下界，在给出某个 Key 时，就能通过比较，定位其所在分区。</p>
<ul>
<li>按键范围分区<strong>好处</strong>在于可以进行<strong>快速的范围查询</strong>。</li>
<li><strong>坏处</strong>在于，数据分散<strong>不均匀</strong>，且容易造成<strong>热点</strong>。</li>
</ul>
<blockquote>
<p>比如关键字是时间戳，可能导致在近期的分区写入负载高，但是其他分区处于空闲状态。</p>
<p>解决方法就是使用除了时间戳以外的其他内容作为关键字的第一项，使用<strong>拼接主键</strong>的方式。</p>
</blockquote>
<h2 id="按键散列分区"><a href="#按键散列分区" class="headerlink" title="按键散列分区"></a>按键散列分区</h2><p>为了避免数据倾斜和读写热点，许多数据系统使用散列函数对键进行分区。</p>
<blockquote>
<p><strong>一致性哈希</strong>也是基于散列分区，它不仅解决了从键到分区的映射，也解决了分区到节点的映射。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/08/06/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-5-%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://dawnzzz.github.io/2023/08/03/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-4-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="DawnZH">
      <meta itemprop="description" content="个人博客站点">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dawn's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/03/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-4-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">数据密集型应用系统设计 (4) 数据复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-08-03 11:16:25" itemprop="dateCreated datePublished" datetime="2023-08-03T11:16:25+08:00">2023-08-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-15 10:35:06" itemprop="dateModified" datetime="2023-12-15T10:35:06+08:00">2023-12-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">数据密集型应用系统设计</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本节讨论主从复制、多主节点复制和无主节点复制。冗余复制有多个好处：</p>
<ul>
<li>降低延迟。</li>
<li>提高可用性。</li>
<li>提高读吞吐。</li>
</ul>
<h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><blockquote>
<p>主从复制需要注意因为读取不同从数据库、或者从数据库与主数据库的不同步，而造成的暂时不一致性。</p>
</blockquote>
<p>主从复制的原理如下：</p>
<ul>
<li><strong>指定某一个副本为主节点。</strong>当客户端写数据库时，必须将写请求发给主节点，主节点首先将新数据写入本地存储。</li>
<li><strong>其他副本为从节点。</strong>主节点将日志发送给所有的从节点，从节点收到日志后应用到本地存储。</li>
<li>客户端可以从主节点或者从节点中执行查询操作。</li>
</ul>
<blockquote>
<p>主从复制中，只有主节点是可写的，从节点仅可读。</p>
</blockquote>
<h2 id="同步复制-异步复制"><a href="#同步复制-异步复制" class="headerlink" title="同步复制 异步复制"></a>同步复制 异步复制</h2><p>复制分为同步复制和异步复制。</p>
<ul>
<li><strong>同步复制：</strong> 主节点发送消息，等待从节点响应。同步复制的优点是，从库保证有与主库一致的最新数据副本。缺点是，如果同步从库没有响应，主库就无法处理写入操作。</li>
<li><strong>异步复制：</strong>主节点发送消息，但不等待从节点的响应。异步复制的速度快、效率高，但是可能会出现数据丢失的情形。</li>
</ul>
<p>基于同步复制和异步复制的优缺点，所以通常情况下采用<strong>半同步复制</strong>。半同步复制就是有既有同步从节点（一个），又有异步从节点。当所有的同步从节点响应后完成写入操作。</p>
<h2 id="从节点的日志同步"><a href="#从节点的日志同步" class="headerlink" title="从节点的日志同步"></a>从节点的日志同步</h2><p>在新的从节点出现时，需要同步主节点中所有的数据。过程如下：</p>
<ul>
<li>在第一次同步时，主节点会给从节点发送某个时刻的一致性<strong>快照</strong>。</li>
<li>从节点同步快照后，此后的同步，就是<strong>增量</strong>拉取所有的数据变更。</li>
</ul>
<h2 id="处理节点宕机"><a href="#处理节点宕机" class="headerlink" title="处理节点宕机"></a>处理节点宕机</h2><p>在分布式系统中，任何节点都可能发生宕机。所以必须处理节点的宕机行为，保证集群的高可用。</p>
<h3 id="从库失效：追赶恢复"><a href="#从库失效：追赶恢复" class="headerlink" title="从库失效：追赶恢复"></a>从库失效：追赶恢复</h3><p>如果是从节点失效了，则恢复比较<strong>容易</strong>。从节点可以从日志中知道，在发生故障之前<strong>处理的最后一个事务</strong>。从库因此可以向主库请求<strong>同步之后的所有数据变更</strong>，直到追上主节点的数据。</p>
<h3 id="主库失效：故障切换"><a href="#主库失效：故障切换" class="headerlink" title="主库失效：故障切换"></a>主库失效：故障切换</h3><p>如果是主节点失效了，则恢复起来非常<strong>棘手</strong>。其中<strong>一个从库需要被提升为新的主库</strong>，并且需要重新配<strong>置客户端中主库的地址</strong>，其他从节点需要拉取新的主节点的数据变更，这个过程就是<strong>故障切换</strong>。</p>
<p>故障切换可以手动进行（通过数据库管理员），或者是自动进行。自动故障切换的过程如下：</p>
<ul>
<li><strong>确认主库失效。</strong>大多数系统只是简单使用 <strong>超时</strong>：节点频繁地相互来回传递<strong>心跳</strong>，并且如果一个节点在一段时间内没有响应，就认为它挂了。</li>
<li><strong>选择一个新的主库。</strong>通过<strong>选举过程</strong>（这是<strong>共识</strong>问题）来完成，或者可以由之前选定的<strong>控制器节点</strong>来指定新的主库。主库的<strong>最佳人选通常是拥有旧主库最新数据副本的从库</strong>。</li>
</ul>
<blockquote>
<p>故障切换回导致很多问题：</p>
<ul>
<li>如果采用<strong>异步复制</strong>，则可能出现写入操作<strong>丢失</strong>的情况。</li>
<li><strong>新老主节点数据冲突。</strong>新主副本在上位前没有同步完所有日志，旧主副本恢复后，可能会发现和新主副本数据冲突。</li>
<li>发生<strong>脑裂</strong>，集群内部出现多个主节点。</li>
<li><strong>超时阈值选取</strong>。如果超时阈值选取的过小，在不稳定的网络环境中可能会造成主副本频繁的切换。</li>
</ul>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/08/03/%E6%95%B0%E6%8D%AE%E5%AF%86%E9%9B%86%E5%9E%8B%E5%BA%94%E7%94%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1-4-%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">DawnZH</p>
  <div class="site-description" itemprop="description">个人博客站点</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">47</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DawnZH</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
